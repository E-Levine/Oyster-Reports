---
title: "Summary Data Output"
author: "ELevine"
date: "`r Sys.Date()`"
output: 
  html_document:
  word_document: NULL
params:  
    WQ: FALSE
    Dermo: FALSE
    Cage: FALSE
    Rcrt: FALSE
    Repro: TRUE
    Sedi: FALSE
    Srvy: FALSE
    Raw_data: FALSE
---

~~~{=comment}
This file compiles the monthly summary data for the data types marked "TRUE" above. Summary data is output in an Excel sheet, and maintained in the repo for future updates. Data is appended to the end of existing data within the Summary_Data and WQ_Summary_Data Excel files, it does NOT overwrite existing data. 
If Raw_data = TRUE, raw data for updating grant manger data files will also be appended to existing data in the CERP_PBC_Raw_data_file. 
~~~

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)

Author <- c("E Levine") #Change to your name
Database <- "Oysters_25-04-24"  #Set the local database to use
Server = "localhost\\ERICALOCALSQL" #Set the local Server to use
#######File locations required to be updated for use.
Start_date <- as.Date("2025-01-01")
End_date <- as.Date("2025-03-30")

#Packages
if (!require("pacman")) {install.packages("pacman")}
pacman::p_load(odbc, DBI, dbplyr,
  tidyverse, dplyr,  stringr, #DF manipulation
  DT, openxlsx,         #Excel
  lubridate, zoo,         #Dates
  knitr, 
  install = TRUE)

Estuaries <- c("SL", "LX", "CR", "LW")
Sites <- c("CR-E", "CR-W", "LW-L", "LW-R", "LX-N", "LX-S", "SL-C", "SL-N", "SL-S")
LocationID_order <- c("0230", "0231", "0232", "0233",  #CR
                      "0235", "0236", "0237", "0240", "0241", "0312", #LW
                      "0242", "0243", "0244", "0246", "0247", "0249", #LX
                      "0255", "0256", "0257", "0261", "0262", "0264", "0269", "0270", "0271") #SL
Station_order <- c("CR-E1", "CR-E2", "CR-W3", "CR-W4", #CR
                   "LW-L1", "LW-L2", "LW-L3", "LW-R2", "LW-R3", "LW-R4", #LW
                   "LX-N1", "LX-N2", "LX-N3", "LX-S1", "LX-S2", "LX-S3", #LX
                   "SL-C1", "SL-C2", "SL-C3", "SL-N1", "SL-N2", "SL-N3", "SL-S1", "SL-S2", "SL-S3") #SL
Date_exclusion <- c("CR-W4_RetDate", "CR-E2_RetDate", "LW-L2_RetDate", "LW-L3_RetDate", "LW-R3_RetDate", "LW-R4_RetDate", "LX-N2_RetDate", "LX-N3_RetDate", "LX-S2_RetDate", "LX-S3_RetDate", "SL-C2_RetDate", "SL-C3_RetDate", "SL-N2_RetDate", "SL-N3_RetDate", "SL-S2_RetDate", "SL-S3_RetDate")

```

```{css}
caption {
  color: black;
  font-weight: bold;
  font-size: 14;
} 
```

```{r DatabaseDownload}
# Connect to Local database server and pull all necessary data, then close connection 
con <- dbConnect(odbc(),
                    Driver = "SQL Server", 
                    Server = Server,
                    Database = Database,
                    Authentication = "ActiveDirectoryIntegrated")

dboFixedLocations <- tbl(con,in_schema("dbo", "FixedLocations")) %>%
  collect() %>% 
  filter(Estuary %in% Estuaries & grepl("^0", FixedLocationID)) %>% #Limit to primary stations, remove "ARRA" and SLN4
  filter(!grepl("^ARRA", StationName) & StationName != "SL-N-4")

#Water quality
hsdbSampleEventWQ <- tbl(con,in_schema("hsdb", "SampleEventWQ")) %>%
  collect() %>% mutate(FixedLocationID = substring(SampleEventID, 19, 22)) %>% #Create FixedLocationID column and filter to matching IDs
  filter(FixedLocationID %in% dboFixedLocations$FixedLocationID & str_detect(SampleEventWQID, 'COLL')) %>% #Limit to COLL (dermo) data (Pre-2023, WQ is with RCRT. 2023+ is with COLL)
  filter(as.Date(substr(SampleEventID, 8, 15), format = "%Y%m%d") > Start_date & as.Date(substr(SampleEventID, 8, 15), format = "%Y%m%d") < End_date)
dboSampleEventWQ <- tbl(con,in_schema("dbo", "SampleEventWQ")) %>%
  collect() %>% mutate(FixedLocationID = substring(SampleEventID, 19, 22)) %>% #Create FixedLocationID column and filter to matching IDs
  filter(FixedLocationID %in% dboFixedLocations$FixedLocationID & str_detect(SampleEventWQID, 'COLL')) %>% #Limit to COLL (dermo) data
  filter(as.Date(substr(SampleEventID, 8, 15), format = "%Y%m%d") > Start_date & as.Date(substr(SampleEventID, 8, 15), format = "%Y%m%d") < End_date)

#Dermo
hsdbDermo <- tbl(con,in_schema("hsdb", "Dermo")) %>%
  collect() %>% mutate(FixedLocationID = substring(SampleEventID, 19, 22)) %>% #Create FixedLocationID column and filter to matching IDs
  filter(FixedLocationID %in% dboFixedLocations$FixedLocationID) %>%
  filter(as.Date(substr(SampleEventID, 8, 15), format = "%Y%m%d") > Start_date & as.Date(substr(SampleEventID, 8, 15), format = "%Y%m%d") < End_date)
dboDermo <- tbl(con,in_schema("dbo", "Dermo")) %>%
  collect() %>% mutate(FixedLocationID = substring(SampleEventID, 19, 22)) %>% #Create FixedLocationID column and filter to matching IDs
  filter(FixedLocationID %in% dboFixedLocations$FixedLocationID) %>%
  filter(as.Date(substr(SampleEventID, 8, 15), format = "%Y%m%d") > Start_date & as.Date(substr(SampleEventID, 8, 15), format = "%Y%m%d") < End_date)

#Cage
hsdbCage <- tbl(con,in_schema("hsdb", "CageCount")) %>%
  collect() %>% mutate(FixedLocationID = substring(SampleEventID, 19, 22)) %>% #Create FixedLocationID column and filter to matching IDs
  filter(FixedLocationID %in% dboFixedLocations$FixedLocationID) %>%
  filter(as.Date(substr(SampleEventID, 8, 15), format = "%Y%m%d") > Start_date & as.Date(substr(SampleEventID, 8, 15), format = "%Y%m%d") < End_date)
dboCage <- tbl(con,in_schema("dbo", "CageCount")) %>%
  collect() %>% mutate(FixedLocationID = substring(SampleEventID, 19, 22)) %>% #Create FixedLocationID column and filter to matching IDs
  filter(FixedLocationID %in% dboFixedLocations$FixedLocationID) %>%
  filter(as.Date(substr(SampleEventID, 8, 15), format = "%Y%m%d") > Start_date & as.Date(substr(SampleEventID, 8, 15), format = "%Y%m%d") < End_date)
hsdbCageSH <- tbl(con,in_schema("hsdb", "CageSH")) %>%
  collect() %>% mutate(FixedLocationID = substring(CageCountID, 19, 22)) %>% #Create FixedLocationID column and filter to matching IDs
  filter(FixedLocationID %in% dboFixedLocations$FixedLocationID) %>%
  filter(as.Date(substr(CageCountID, 8, 15), format = "%Y%m%d") > Start_date & as.Date(substr(CageCountID, 8, 15), format = "%Y%m%d") < End_date)
dboCageSH <- tbl(con,in_schema("dbo", "CageSH")) %>%
  collect() %>% mutate(FixedLocationID = substring(CageCountID, 19, 22)) %>% #Create FixedLocationID column and filter to matching IDs
  filter(FixedLocationID %in% dboFixedLocations$FixedLocationID) %>%
  filter(as.Date(substr(CageCountID, 8, 15), format = "%Y%m%d") > Start_date & as.Date(substr(CageCountID, 8, 15), format = "%Y%m%d") < End_date)

#Recruitment
hsdbRcrt <- tbl(con,in_schema("hsdb", "Recruitment")) %>%
  collect() %>% mutate(FixedLocationID = substring(SampleEventID, 19, 22)) %>% #Create FixedLocationID column and filter to matching IDs
  filter(FixedLocationID %in% dboFixedLocations$FixedLocationID) %>%
  filter(as.Date(substr(SampleEventID, 8, 15), format = "%Y%m%d") > Start_date & as.Date(substr(SampleEventID, 8, 15), format = "%Y%m%d") < End_date)
dboRcrt <- tbl(con,in_schema("dbo", "Recruitment")) %>%
  collect() %>% mutate(FixedLocationID = substring(SampleEventID, 19, 22)) %>% #Create FixedLocationID column and filter to matching IDs
  filter(FixedLocationID %in% dboFixedLocations$FixedLocationID) %>%
  filter(as.Date(substr(SampleEventID, 8, 15), format = "%Y%m%d") > Start_date & as.Date(substr(SampleEventID, 8, 15), format = "%Y%m%d") < End_date)

#Repro
hsdbRepro <- tbl(con,in_schema("hsdb", "Repro")) %>%
  collect() %>% mutate(FixedLocationID = substring(SampleEventID, 19, 22)) %>% #Create FixedLocationID column and filter to matching IDs
  filter(FixedLocationID %in% dboFixedLocations$FixedLocationID) %>%
  filter(as.Date(substr(SampleEventID, 8, 15), format = "%Y%m%d") > Start_date & as.Date(substr(SampleEventID, 8, 15), format = "%Y%m%d") < End_date)
dboRepro <- tbl(con,in_schema("dbo", "Repro")) %>%
  collect() %>% mutate(FixedLocationID = substring(SampleEventID, 19, 22)) %>% #Create FixedLocationID column and filter to matching IDs
  filter(FixedLocationID %in% dboFixedLocations$FixedLocationID) %>%
  filter(as.Date(substr(SampleEventID, 8, 15), format = "%Y%m%d") > Start_date & as.Date(substr(SampleEventID, 8, 15), format = "%Y%m%d") < End_date)

#PBC Sediment
hsdbSedi <- tbl(con,in_schema("hsdb", "SedimentTrap")) %>%
  collect() %>% mutate(FixedLocationID = substring(SampleEventID, 19, 22)) %>% #Create FixedLocationID column and filter to matching IDs
  filter(FixedLocationID %in% dboFixedLocations$FixedLocationID) %>%
  filter(as.Date(substr(SampleEventID, 8, 15), format = "%Y%m%d") > Start_date & as.Date(substr(SampleEventID, 8, 15), format = "%Y%m%d") < End_date)
dboSedi <- tbl(con,in_schema("dbo", "SedimentTrap")) %>%
  collect() %>% mutate(FixedLocationID = substring(SampleEventID, 19, 22)) %>% #Create FixedLocationID column and filter to matching IDs
  filter(FixedLocationID %in% dboFixedLocations$FixedLocationID) %>%
  filter(as.Date(substr(SampleEventID, 8, 15), format = "%Y%m%d") > Start_date & as.Date(substr(SampleEventID, 8, 15), format = "%Y%m%d") < End_date)

#Survey
hsdbSrvy <- tbl(con,in_schema("hsdb", "SurveyQuadrat")) %>%
  collect() %>% mutate(FixedLocationID = substring(SampleEventID, 19, 22)) %>% #Create FixedLocationID column and filter to matching IDs
  filter(FixedLocationID %in% dboFixedLocations$FixedLocationID) %>%
  filter(as.Date(substr(SampleEventID, 8, 15), format = "%Y%m%d") > Start_date & as.Date(substr(SampleEventID, 8, 15), format = "%Y%m%d") < End_date)
dboSrvy <- tbl(con,in_schema("dbo", "SurveyQuadrat")) %>%
  collect() %>% mutate(FixedLocationID = substring(SampleEventID, 19, 22)) %>% #Create FixedLocationID column and filter to matching IDs
  filter(FixedLocationID %in% dboFixedLocations$FixedLocationID) %>%
  filter(as.Date(substr(SampleEventID, 8, 15), format = "%Y%m%d") > Start_date & as.Date(substr(SampleEventID, 8, 15), format = "%Y%m%d") < End_date)
hsdbSrvySH <- tbl(con,in_schema("hsdb", "SurveySH")) %>%
  collect() %>% mutate(FixedLocationID = substring(QuadratID, 19, 22)) %>% #Create FixedLocationID column and filter to matching IDs
  filter(FixedLocationID %in% dboFixedLocations$FixedLocationID) %>%
  filter(as.Date(substr(QuadratID, 8, 15), format = "%Y%m%d") > Start_date & as.Date(substr(QuadratID, 8, 15), format = "%Y%m%d") < End_date) %>%
  mutate(SH_n = as.integer(substr(ShellHeightID, 29,31))) %>% filter(SH_n < 11)
dboSrvySH <- tbl(con,in_schema("dbo", "SurveySH")) %>%
  collect() %>% mutate(FixedLocationID = substring(QuadratID, 19, 22)) %>% #Create FixedLocationID column and filter to matching IDs
  filter(FixedLocationID %in% dboFixedLocations$FixedLocationID) %>% mutate(ShellHeight = as.integer(ShellHeight)) %>%
  filter(as.Date(substr(QuadratID, 8, 15), format = "%Y%m%d") > Start_date & as.Date(substr(QuadratID, 8, 15), format = "%Y%m%d") < End_date) %>%
  mutate(SH_n = as.integer(substr(ShellHeightID, 29,31))) %>% filter(SH_n < 11)

DBI::dbDisconnect(con)
```

```{r Data setup}
#Data cleaning used for raw output, summary output, or both
#
##WQ
#List of WQ params
WQ_params <- c("DO","Pct", "pH", "Sal", "SP", "Temp")

#Combined table of all parameters
WQ_combined <- left_join(rbind((hsdbSampleEventWQ %>% filter(DataStatus == "Proofed" | DataStatus == "Completed")), (dboSampleEventWQ %>% filter(DataStatus == "Proofed"))) %>%
  #Create date columns and Secchi penetration
  mutate(RetDate = as.Date(substring(SampleEventID, 8, 15), format = "%Y%m%d"),
         AnalysisDate = as.Date(floor_date(RetDate, unit = "month")),
         SP = round((Secchi/Depth) * 100, 2)) %>%
  #Filter data to desired columns needed for summary
  dplyr::select(AnalysisDate, RetDate, SampleEventWQID, SampleEventID, FixedLocationID, DissolvedOxygen, PercentDissolvedOxygen, pH, Salinity, SP, Temperature, CollectionTime, SampleDepth, TurbidityYSI, TurbidityHach) %>% rename(DO = DissolvedOxygen, Pct = PercentDissolvedOxygen, Sal = Salinity, Temp = Temperature) %>%
  #Arrange by station then date
  arrange(match(FixedLocationID, c(LocationID_order)), AnalysisDate),
  #Add simplified StationName 
  dboFixedLocations %>% 
    mutate(StationName = paste0(Estuary, "-", SectionName, StationNumber),
           Site = paste0(Estuary, "-", SectionName)) %>%
    dplyr::select(FixedLocationID, Site, StationName)) %>%
  filter(!if_all(c("DO", "Pct", "pH", "Sal", "SP", "Temp"), ~is.na(.)))
#
##Raw data output
WQ_raw_data <- WQ_combined %>% dplyr::select(RetDate, Site, StationName, CollectionTime, SampleDepth, Temp, Sal, pH, DO, Pct, SP, TurbidityYSI, TurbidityHach) %>% rename("Station" = StationName, "DOPct" = Pct, "Secchi" = SP) %>% mutate(RetDate = format(RetDate, "%m/%d/%Y"), Station = as.numeric(substr(Station, nchar(Station), nchar(Station))), CollectionTime = str_c(str_sub(CollectionTime, 1, nchar(CollectionTime) - 2), ":", str_sub(CollectionTime, -2))) %>% mutate(ChlA = "Z", .before = TurbidityYSI) %>% mutate(Year = year(as.Date(RetDate, format = "%m/%d/%Y")), Month = month(as.Date(RetDate, format = "%m/%d/%Y")), .before = "RetDate")
#
if(params$WQ && !params$Raw_data){
  WQ_combined <- WQ_combined
  rm(WQ_raw_data)
} else if(!params$WQ && params$Raw_data){
    WQ_raw_data <- WQ_raw_data
    rm(WQ_combined)
} else {
    rm(WQ_combined, WQ_raw_data)
  }
#
#
##Dermo
#Combined table of all parameters
Dermo_combined <- left_join(rbind((hsdbDermo %>% dplyr::select(-OldSampleNumber) %>% filter(DataStatus == "Proofed" | DataStatus == "Completed")), (dboDermo %>% filter(DataStatus == "Proofed"))) %>%
  #Create date columns 
  mutate(RetDate = as.Date(substring(SampleEventID, 8, 15), format = "%Y%m%d"),
         AnalysisDate = as.Date(floor_date(RetDate, unit = "month")),
         MeanDermo = rowMeans(.[, c("DermoMantle", "DermoGill")], na.rm = TRUE),
         DermoSum = as.numeric(ifelse(rowSums(select(., contains("Dermo"))) >0, 1, 0))) %>%
  #Filter data to desired columns needed for summary
  dplyr::select(AnalysisDate, RetDate, OysterID, SampleEventID, FixedLocationID, DermoMantle, DermoGill, MeanDermo, DermoSum, ShellHeight, TotalWeight, ShellWetWeight, Comments) %>% 
  #Arrange by station then date
  arrange(match(FixedLocationID, c(LocationID_order)), AnalysisDate),
  #Add simplified StationName 
  dboFixedLocations %>% 
    mutate(StationName = paste0(Estuary, "-", SectionName, StationNumber),
           Site = paste0(Estuary, "-", SectionName)) %>%
    dplyr::select(FixedLocationID, Site, StationName)) %>%
  #Filter to make sure only 15 first samples
  filter(as.numeric(substr(OysterID, nchar(OysterID)-1, nchar(OysterID))) < 16)

##Dermo raw data
Dermo_raw_data <- Dermo_combined %>% dplyr::select(RetDate, Site, StationName, ShellHeight, TotalWeight, ShellWetWeight, DermoMantle, DermoGill, Comments) %>% rename("Station" = StationName) %>% mutate(RetDate = format(RetDate, "%m/%d/%Y"), Station = as.numeric(substr(Station, nchar(Station), nchar(Station)))) %>% mutate(Year = year(as.Date(RetDate, format = "%m/%d/%Y")), Month = month(as.Date(RetDate, format = "%m/%d/%Y")), .before = "RetDate")
#
if(params$Dermo && !params$Raw_data){
  Dermo_combined <- Dermo_combined
  rm(Dermo_raw_data)
} else if(!params$Dermo && params$Raw_data){
    Dermo_raw_data <- Dermo_raw_data
    rm(Dermo_combined)
} else if(params$Repro == T){
  Dermo_combined <- Dermo_combined
  } else {
    rm(Dermo_combined, Dermo_raw_data)
  }
#
#
#
##Cage
Cage_reps <- c("CR-E-B", "CR-E-R", "CR-E-Y", "CR-W-B", "CR-W-R", "CR-W-Y", "LX-N-B", "LX-N-R", "LX-N-Y", "SL-C-B", "SL-C-R", "SL-C-Y")
Cage_Sites <- c("CR-E", "CR-W", "LX-N", "SL-C")

#Combined table of cage counts
Cage_combined <- left_join(rbind((hsdbCage %>% filter(DataStatus == "Proofed" | DataStatus == "Completed")), (dboCage %>% filter(DataStatus == "Proofed"))) %>%
  #Create date columns 
  mutate(RetDate = as.Date(substring(SampleEventID, 8, 15), format = "%Y%m%d"),
         AnalysisDate = as.Date(floor_date(RetDate, unit = "month")),
         CageID = substring(CageCountID, 28, 28)) %>%
  #Filter data to desired columns needed for summary
  dplyr::select(AnalysisDate, RetDate, CageID, SampleEventID, FixedLocationID, DataType, TotalCount, DeployedDate, DaysDeployed, Comments) %>% 
  #Arrange by station then date
  arrange(match(FixedLocationID, c(LocationID_order)), AnalysisDate),
  #Add simplified StationName 
  dboFixedLocations %>% 
    mutate(StationName = paste0(Estuary, "-", SectionName, StationNumber),
           Site = paste0(Estuary, "-", SectionName)) %>%
    dplyr::select(FixedLocationID, Site, StationName)) %>% 
  pivot_wider(names_from = DataType, values_from = TotalCount) %>% mutate(CageName = paste0(Site, "-", CageID),
                                                                          DeadPct = 100-((Retrieved/Deployed)*100))
#
CageSH_combined <- left_join(rbind((hsdbCageSH %>% filter(DataStatus == "Completed")), (dboCageSH %>% filter(DataStatus == "Proofed"))) %>%
  #Create date columns 
  mutate(RetDate = as.Date(substring(CageCountID, 8, 15), format = "%Y%m%d"),
         AnalysisDate = as.Date(floor_date(RetDate, unit = "month")),
         CageID = substring(CageCountID, 28, 28),
         DataType = substring(CageCountID, 26, 26),
         ShellHeight = as.integer(ShellHeight)) %>%
  #Filter data to desired date range and select columns needed for summary
  filter(RetDate > Start_date & RetDate < End_date) %>%
  dplyr::select(AnalysisDate, RetDate, CageCountID, FixedLocationID, CageID, DataType, ShellHeight, ShellHeightID) %>% 
  #Arrange by station then date
  arrange(match(FixedLocationID, c(LocationID_order)), AnalysisDate),
  #Add simplified StationName 
  dboFixedLocations %>% 
    mutate(StationName = paste0(Estuary, "-", SectionName, StationNumber),
           Site = paste0(Estuary, "-", SectionName)) %>%
    dplyr::select(FixedLocationID, Site, StationName)) %>%
  mutate(DataType = factor(DataType, levels =c("D", "R"), labels = c("Dep", "Ret")), 
         CageName = paste0(Site, "-", CageID))

##Cage raw data
Cage_counts_raw_data <- Cage_combined %>% dplyr::select(DeployedDate, RetDate, DaysDeployed, Site, StationName, CageName, Deployed, Retrieved, Comments) %>% rename("Station" = StationName, "Cage" = CageName) %>% mutate(DepJulian = as.numeric(as.Date(DeployedDate) - as.Date("2005-01-01")) + 1, .before = DaysDeployed) %>% mutate(RetJulian = as.numeric(RetDate - as.Date("2005-01-01")) + 1, .before = DaysDeployed) %>% mutate(RetDate = format(RetDate, "%m/%d/%Y"), DeployedDate = format(as.Date(DeployedDate), "%m/%d/%Y"), Station = as.numeric(substr(Station, nchar(Station), nchar(Station))), Cage = case_when(substr(Cage, nchar(Cage), nchar(Cage)) == "R" ~ "Red", substr(Cage, nchar(Cage), nchar(Cage)) == "Y" ~ "Yellow", substr(Cage, nchar(Cage), nchar(Cage)) == "B" ~ "Brown", TRUE ~ "Other")) %>% mutate(Year = year(as.Date(RetDate, format = "%m/%d/%Y")), Month = month(as.Date(RetDate, format = "%m/%d/%Y")), .before = "RetDate")

Cage_SH_raw_data <-full_join(CageSH_combined %>% dplyr::select(ShellHeightID, RetDate, CageID, DataType, ShellHeight, FixedLocationID) %>% filter(DataType == "Dep") %>% arrange(ShellHeightID) %>% rename("Dep" = ShellHeight) %>% mutate(CageID = case_when(CageID == "R" ~ "Red", CageID == "Y" ~ "Yellow", CageID == "B" ~ "Brown", TRUE ~ "Other"), ShellHeightID = gsub("_(B|R|Y|D)", "", ShellHeightID)) %>% dplyr::select(-DataType), CageSH_combined %>% dplyr::select(ShellHeightID, RetDate, CageID, DataType, ShellHeight) %>% filter(DataType == "Ret") %>% arrange(ShellHeightID) %>% rename("Ret" = ShellHeight) %>% mutate(CageID = case_when(CageID == "R" ~ "Red", CageID == "Y" ~ "Yellow", CageID == "B" ~ "Brown", TRUE ~ "Other"), ShellHeightID = gsub("_(B|R|Y|D)", "", ShellHeightID)) %>% dplyr::select(-DataType)) %>% rename("Cage" = CageID) %>% left_join(dboFixedLocations %>% mutate(Site = paste0(Estuary,"-",SectionName)) %>% dplyr::select(FixedLocationID, Site, "Station" = StationNumber)) %>% dplyr::select(-ShellHeightID, -FixedLocationID) %>% mutate(RetDate = format(RetDate, "%m/%d/%Y")) %>% left_join(Cage_counts_raw_data %>% dplyr::select(DeployedDate:Cage), by = c("RetDate", "Cage", "Site", "Station")) %>% dplyr::select(DeployedDate, RetDate, DepJulian, RetJulian, DaysDeployed, Site, Station, Cage, Dep, Ret) %>% mutate(Year = year(as.Date(RetDate, format = "%m/%d/%Y")), Month = month(as.Date(RetDate, format = "%m/%d/%Y")), .before = "DeployedDate")
#
if(params$Cage && !params$Raw_data){
  Cage_combined <- Cage_combined
  CageSH_combined <- CageSH_combined
  rm(Cage_counts_raw_data, Cage_SH_raw_data)
} else if(!params$Cage && params$Raw_data){
    Cage_counts_raw_data <- Cage_counts_raw_data
    Cage_SH_raw_data <- Cage_SH_raw_data
    rm(Cage_combined, CageSH_combined)
} else {
    rm(Cage_combined, CageSH_combined, Cage_counts_raw_data, Cage_SH_raw_data)
  }
#
#
#
##Rcrt
##Raw data 
Rcrt_raw_data <- left_join(rbind((hsdbRcrt %>% filter(DataStatus == "Proofed" | DataStatus == "Completed")), (dboRcrt %>% filter(DataStatus == "Proofed"))) %>% mutate(RetDate = as.Date(substring(SampleEventID, 8, 15), format = "%Y%m%d"), DeployedDate = as.Date(DeployedDate, format = "%Y-%m-%d")) %>% dplyr::select(RetDate, DeployedDate, ShellID, SampleEventID, FixedLocationID, ShellReplicate, ShellPosition, NumBottom, NumTop, Comments) %>% arrange(match(FixedLocationID, c(LocationID_order)), RetDate), dboFixedLocations %>% mutate(Site = paste0(Estuary, "-", SectionName)) %>% dplyr::select(FixedLocationID, Site, StationNumber)) %>% mutate(DaysDeployed = as.numeric(RetDate - DeployedDate), DepJulian = as.numeric(as.Date(DeployedDate) - as.Date("2005-01-01")) + 1, RetJulian = as.numeric(RetDate - as.Date("2005-01-01")) + 1) %>% rename("Rep"= ShellReplicate, "Shell" = ShellPosition, "Station" = StationNumber) %>% mutate(RetDate = format(RetDate, "%m/%d/%Y")) %>% dplyr::select(RetDate, RetJulian, DepJulian, DaysDeployed, Site, Station, Rep, Shell, NumBottom, NumTop, Comments) %>% mutate(Year = year(as.Date(RetDate, format = "%m/%d/%Y")), Month = month(as.Date(RetDate, format = "%m/%d/%Y")), .before = "RetDate")
#
if(!params$Raw_data){
   rm(Rcrt_raw_data)
} else {Rcrt_raw_data <- Rcrt_raw_data
   } 
#
#
#
##Repro
##Raw data
Repro_raw_data <- left_join(rbind((hsdbRepro %>% dplyr::select(-OldSampleNumber) %>% filter(DataStatus == "Proofed" | DataStatus == "Completed")), (dboRepro  %>% filter(DataStatus == "Proofed"))) %>% mutate(RetDate = as.Date(substring(SampleEventID, 8, 15), format = "%Y%m%d"), ReproStage = as.factor(ReproStage)) %>% dplyr::select(RetDate, OysterID, SampleEventID, FixedLocationID, Sex, ReproStage, Parasite, BadSlide) %>% arrange(match(FixedLocationID, c(LocationID_order))), dboFixedLocations %>% mutate(Site = paste0(Estuary, "-", SectionName)) %>% dplyr::select(FixedLocationID, Site, StationNumber)) %>% left_join(Dermo_combined %>% dplyr::select(OysterID, ShellHeight)) %>% mutate(SampleNumber = as.integer(substr(OysterID, nchar(OysterID)-1, nchar(OysterID))), OldStage = "Z", MSXPresent = "Z", MSXStage = "Z", M_F = case_when(Sex == "M/F" ~ "Yes", TRUE ~ "No"), BadSlide = case_when(BadSlide == "N" ~ "No", BadSlide == "Y" ~ "Yes", TRUE ~ "Other")) %>% dplyr::select(RetDate, Site, SampleNumber, StationNumber, ShellHeight, Sex, ReproStage, OldStage, MSXPresent, MSXStage, Parasite, M_F, BadSlide) %>% rename("Station" = StationNumber) %>% mutate(RetDate = format(RetDate, "%m/%d/%Y"), ReproStage = case_when(ReproStage == "M/F" ~ "Z", TRUE ~ ReproStage)) %>% mutate(Year = year(as.Date(RetDate, format = "%m/%d/%Y")), Month = month(as.Date(RetDate, format = "%m/%d/%Y")), .before = "RetDate") %>% filter(SampleNumber < 16)
#
if(!params$Raw_data){
   rm(Repro_raw_data)
} else {Repro_raw_data <- Repro_raw_data
   } 
#
#
#
#
##Srvy
#Combined table of survey counts
Srvy_combined <- left_join(rbind((hsdbSrvy %>% filter(DataStatus == "Proofed" | DataStatus == "Completed")), (dboSrvy %>% filter(DataStatus == "Proofed"))) %>%
  #Create date columns 
  mutate(RetDate = as.Date(substring(SampleEventID, 8, 15), format = "%Y%m%d"),
         AnalysisDate = as.Date(floor_date(RetDate, unit = "month")),
         Live = NumLive * 4,
         Dead = NumDead * 4,
         DeadRatio = Dead/(Live + Dead)) %>%
  #Filter data to desired columns needed for summary
  dplyr::select(AnalysisDate, RetDate, QuadratID, SampleEventID, FixedLocationID, Live, Dead, DeadRatio) %>% 
  #Arrange by station then date
  arrange(match(FixedLocationID, c(LocationID_order)), AnalysisDate),
  #Add simplified StationName 
  dboFixedLocations %>% 
    mutate(StationName = paste0(Estuary, "-", SectionName, StationNumber),
           Site = paste0(Estuary, "-", SectionName)) %>%
    dplyr::select(FixedLocationID, Site, StationName))
#
SH_combined <- left_join(rbind((hsdbSrvySH %>% filter(DataStatus == "Proofed"| DataStatus == "Completed")), (dboSrvySH %>% filter(DataStatus == "Proofed"))) %>%
  #Create date columns 
  mutate(RetDate = as.Date(substring(QuadratID, 8, 15), format = "%Y%m%d"),
         AnalysisDate = as.Date(floor_date(RetDate, unit = "month"))) %>%
  #Filter data to desired columns needed for summary
  dplyr::select(AnalysisDate, RetDate, ShellHeightID, QuadratID, FixedLocationID, ShellHeight) %>% 
  #Arrange by station then date
  arrange(match(FixedLocationID, c(LocationID_order)), AnalysisDate),
  #Add simplified StationName 
  dboFixedLocations %>% 
    mutate(StationName = paste0(Estuary, "-", SectionName, StationNumber),
           Site = paste0(Estuary, "-", SectionName)) %>%
    dplyr::select(FixedLocationID, Site, StationName))

#Raw data
Srvy_counts_raw_data <- left_join(rbind((hsdbSrvy %>% filter(DataStatus == "Proofed" | DataStatus == "Completed")), (dboSrvy %>% filter(DataStatus == "Proofed"))) %>% mutate(RetDate = as.Date(substring(SampleEventID, 8, 15), format = "%Y%m%d")) %>% dplyr::select(RetDate, QuadratID, SampleEventID, FixedLocationID, NumLive, NumDead) %>% arrange(match(FixedLocationID, c(LocationID_order)), RetDate), dboFixedLocations %>% mutate(Site = paste0(Estuary, "-", SectionName)) %>% dplyr::select(FixedLocationID, Site, StationNumber)) %>% mutate(QuadratID = as.integer(substr(QuadratID, nchar(QuadratID)-1, nchar(QuadratID))), Survey = paste(case_when(format(RetDate, "%m") == "03" ~ "Spring", format(RetDate, "%m") == "06" ~ "Summer", format(RetDate, "%m") == "09" ~ "Fall", format(RetDate, "%m") == "12" ~ "Winter", TRUE ~ "Other"), format(RetDate, "%Y"))) %>% dplyr::select(Survey, Site, RetDate, StationNumber, QuadratID, NumLive, NumDead) %>% rename("Station" = StationNumber) %>% mutate(RetDate = format(RetDate, "%m/%d/%Y")) %>% mutate(Year = year(as.Date(RetDate, format = "%m/%d/%Y")), Month = month(as.Date(RetDate, format = "%m/%d/%Y")), .before = "RetDate")

Srvy_SH_raw_data <- SH_combined %>% arrange(RetDate, Site, StationName, ShellHeightID) %>% mutate(Survey = paste(case_when(format(RetDate, "%m") == "03" ~ "Spring", format(RetDate, "%m") == "06" ~ "Summer", format(RetDate, "%m") == "09" ~ "Fall", format(RetDate, "%m") == "12" ~ "Winter", TRUE ~ "Other"), format(RetDate, "%Y"))) %>% dplyr::select(Survey, Site, RetDate, StationName, ShellHeightID, ShellHeight) %>% mutate(RetDate = format(RetDate, "%m/%d/%Y"), ShellHeightID = as.integer(substr(ShellHeightID, nchar(ShellHeightID)-5, nchar(ShellHeightID)-4)), StationName = as.numeric(substr(StationName, nchar(StationName), nchar(StationName)))) %>% rename("Station" = StationName, "Quadrat" = ShellHeightID) %>% mutate(Year = year(as.Date(RetDate, format = "%m/%d/%Y")), Month = month(as.Date(RetDate, format = "%m/%d/%Y")), .before = "RetDate")
#
if(params$Srvy && !params$Raw_data){
  Srvy_combined <- Srvy_combined
  SH_combined <- SH_combined
  rm(Srvy_counts_raw_data, Srvy_SH_raw_data)
} else if(!params$Srvy && params$Raw_data){
    Srvy_counts_raw_data <- Srvy_counts_raw_data
    Srvy_SH_raw_data <- Srvy_SH_raw_data
    rm(Srvy_combined, SH_combined)
} else {
    rm(Srvy_combined, SH_combined, Srvy_counts_raw_data, Srvy_SH_raw_data)
  }
#
#
```

```{r WQ data tables, eval = params$WQ}
#
##WQ output summary
WQ_out_list <- list()
for(w in WQ_params){
  WQ_Out <- WQ_combined %>% dplyr::select(-CollectionTime, -SampleDepth, -TurbidityYSI, -TurbidityHach) %>% group_by(StationName, AnalysisDate) %>% summarise(across(where(is.numeric), list(sum=sum))) %>% rename_with(~sub("_sum", "", .x)) #across(everything(), ~sum(!is.na(.))))
  WQ_out_w <- WQ_Out %>% dplyr::select(StationName, AnalysisDate, all_of(w)) %>% pivot_wider(names_from = StationName, values_from = w) %>% mutate(AnalysisDate = str_replace(AnalysisDate, "-01", "")) %>% ungroup()
  WQ_out_list[[w]] <- WQ_out_w
}

##Summary by Station
#Create empty data frame with analysis dates
Station_summary <- data.frame(AnalysisDate = unique(WQ_combined$AnalysisDate))#WQ_combined %>% distinct(Site, RetDate))
for(i in WQ_params){
  for(j in Station_order){
    Summary_jS <- WQ_combined %>% dplyr::select(-CollectionTime, -SampleDepth, -TurbidityYSI, -TurbidityHach)  %>% 
      #Select columns for each WQ param, filter to Station by FixedLocationID, and group for summary
      dplyr::select(StationName, AnalysisDate, RetDate, all_of(i)) %>% filter(StationName == j) %>% group_by(AnalysisDate, RetDate) %>% dplyr::select(-StationName) %>%
      #Rename columns: Add StationName to beginning, reformat RetDate for cleaning
      rename_with(.fn = ~ifelse(.x != "AnalysisDate", paste0(j, "_", .x), .x), .cols = -all_of("AnalysisDate")) %>% rename_with(.fn = ~ifelse(str_detect(.x, "RetDate"), paste0(j,"_", "RetDate_", i), .x), .cols = everything())
    #
    #Join with existing data
    Station_summary <- left_join(Station_summary, Summary_jS, by = "AnalysisDate")
  #Clean columns for selection and output
  Station_summ <- Station_summary %>% dplyr::select(-contains(Date_exclusion)) %>% rename_with(~sub("(\\d)_RetDate", "_RetDate", .x)) %>%
    mutate(across(where(is.numeric), round, 2)) %>% arrange(AnalysisDate)
  }
}


##Summary by Site
#Create empty data frame with analysis dates
Site_summary <- data.frame(AnalysisDate = unique(WQ_combined$AnalysisDate))#WQ_combined %>% distinct(Site, RetDate))
for(i in WQ_params){
  for(j in Sites){
    Summary_j <- WQ_combined %>% dplyr::select(-CollectionTime, -SampleDepth, -TurbidityYSI, -TurbidityHach) %>% 
      #Select columns for each WQ param, filter to Site, and group for summary
      dplyr::select(Site, AnalysisDate, RetDate, i) %>% filter(Site == j) %>% group_by(AnalysisDate, RetDate) %>% 
      #Calculate mean, SD, min, and max of parameter
      summarise(across(.cols = where(is.numeric), .fns = list(A_Mean = mean, B_SD = sd, C_Min = min, D_Max = max), na.rm = T, .names = "{fn}{col}")) %>% 
      #Rename columns: Add Site to beginning, reformat RetDate for cleaning
      rename_with(.fn = ~ifelse(.x != "AnalysisDate", paste0(j, "_", .x), .x), .cols = -all_of("AnalysisDate")) %>% rename_with(.fn = ~ifelse(str_detect(.x, "RetDate"), paste0(j,"_A_", i, "_RetDate"), .x), .cols = everything())
    #
    #Join with existing data
    Site_summary <- left_join(Site_summary, Summary_j, by = "AnalysisDate")
  }
  #Clean columns for selection and output
  Site_summ <- Site_summary %>% rename_with(., function(x){str_replace(x, "(\\_)[A-Z]","")}) %>%
    mutate(across(where(is.numeric), round, 2)) %>% mutate(across(where(is.numeric), ~na_if(.x, Inf))) %>% mutate(across(where(is.numeric), ~na_if(.x, -Inf))) %>% arrange(AnalysisDate)

}
#
#
  #Load each sheet and append new data
  DO_Station <- readWorkbook("../Data/CERP_PBC_WQ_Summary_Data.xlsx", sheet = 'DO Station', detectDates = TRUE) %>% mutate(across(contains("RetDate"), ~as.Date(.x, format = "%Y-%m-%d")), across(!contains("RetDate"), ~as.numeric(.x))) %>% bind_rows(Station_summ %>% dplyr::select(contains("DO")))
  DO_Site <- readWorkbook("../Data/CERP_PBC_WQ_Summary_Data.xlsx", sheet = 'DO Site', detectDates = TRUE) %>% mutate(across(contains("RetDate"), ~as.Date(.x, format = "%Y-%m-%d")), across(!contains("RetDate"), ~as.numeric(.x))) %>% bind_rows(Site_summ %>% dplyr::select(contains("DO")))
  DOPct_Station <- readWorkbook("../Data/CERP_PBC_WQ_Summary_Data.xlsx", sheet = 'DO% Station', detectDates = TRUE) %>% mutate(across(contains("RetDate"), ~as.Date(.x, format = "%Y-%m-%d")), across(!contains("RetDate"), ~as.numeric(.x))) %>%  bind_rows(Station_summ %>% dplyr::select(contains("Pct")))
  DOPct_Site <- readWorkbook("../Data/CERP_PBC_WQ_Summary_Data.xlsx", sheet = 'DO% Site', detectDates = TRUE) %>% mutate(across(contains("RetDate"), ~as.Date(.x, format = "%Y-%m-%d")), across(!contains("RetDate"), ~as.numeric(.x))) %>% bind_rows(Site_summ %>% dplyr::select(contains("Pct"))) 
  pH_Station <- readWorkbook("../Data/CERP_PBC_WQ_Summary_Data.xlsx", sheet = 'pH Station', detectDates = TRUE) %>% mutate(across(contains("RetDate"), ~as.Date(.x, format = "%Y-%m-%d")), across(!contains("RetDate"), ~as.numeric(.x))) %>% bind_rows(Station_summ %>% dplyr::select(contains("pH")))
  pH_Site <- readWorkbook("../Data/CERP_PBC_WQ_Summary_Data.xlsx", sheet = 'pH Site', detectDates = TRUE) %>% mutate(across(contains("RetDate"), ~as.Date(.x, format = "%Y-%m-%d")), across(!contains("RetDate"), ~as.numeric(.x))) %>% bind_rows(Site_summ %>% dplyr::select(contains("pH")))
  Sal_Station <- readWorkbook("../Data/CERP_PBC_WQ_Summary_Data.xlsx", sheet = 'Salinity Station', detectDates = TRUE) %>% mutate(across(contains("RetDate"), ~as.Date(.x, format = "%Y-%m-%d")), across(!contains("RetDate"), ~as.numeric(.x))) %>% bind_rows(Station_summ %>% dplyr::select(contains("Sal")))
  Sal_Site <- readWorkbook("../Data/CERP_PBC_WQ_Summary_Data.xlsx", sheet = 'Salinity Site', detectDates = TRUE) %>% mutate(across(contains("RetDate"), ~as.Date(.x, format = "%Y-%m-%d")), across(!contains("RetDate"), ~as.numeric(.x))) %>% bind_rows(Site_summ %>% dplyr::select(contains("Sal")))
  SP_Station <- readWorkbook("../Data/CERP_PBC_WQ_Summary_Data.xlsx", sheet = 'Secchi Station', detectDates = TRUE) %>% mutate(across(contains("RetDate"), ~as.Date(.x, format = "%Y-%m-%d")), across(!contains("RetDate"), ~as.numeric(.x))) %>% bind_rows(Station_summ %>% dplyr::select(contains("SP")))
  SP_Site <- readWorkbook("../Data/CERP_PBC_WQ_Summary_Data.xlsx", sheet = 'Secchi Site', detectDates = TRUE) %>% mutate(across(contains("RetDate"), ~as.Date(.x, format = "%Y-%m-%d")), across(!contains("RetDate"), ~as.numeric(.x))) %>% bind_rows(Site_summ %>% dplyr::select(contains("SP")))
  Temp_Station <- readWorkbook("../Data/CERP_PBC_WQ_Summary_Data.xlsx", sheet = 'Temp Station', detectDates = TRUE) %>% mutate(across(contains("RetDate"), ~as.Date(.x, format = "%Y-%m-%d")), across(!contains("RetDate"), ~as.numeric(.x))) %>% bind_rows(Station_summ %>% dplyr::select(contains("Temp")))
  Temp_Site <- readWorkbook("../Data/CERP_PBC_WQ_Summary_Data.xlsx", sheet = 'Temp Site', detectDates = TRUE) %>% mutate(across(contains("RetDate"), ~as.Date(.x, format = "%Y-%m-%d")), across(!contains("RetDate"), ~as.numeric(.x))) %>% mutate(across(contains("RetDate"), ~as.Date(.x, format = "%Y-%m-%d"))) %>% bind_rows(Site_summ %>% dplyr::select(contains("Temp")))
  
  #Load workbook of existing data
  WQ_wb <- loadWorkbook("../Data/CERP_PBC_WQ_Summary_Data.xlsx")
  #Overwrite each sheet with new data appended to old
  writeData(WQ_wb, "DO Station", DO_Station)
  writeData(WQ_wb, "DO Site", DO_Site)
  writeData(WQ_wb, "DO% Station", DOPct_Station)
  writeData(WQ_wb, "DO% Site", DOPct_Site)
  writeData(WQ_wb, "pH Station", pH_Station)
  writeData(WQ_wb, "pH Site", pH_Site)
  writeData(WQ_wb, "Salinity Station", Sal_Station)
  writeData(WQ_wb, "Salinity Site", Sal_Site)
  writeData(WQ_wb, "Secchi Station", SP_Station)
  writeData(WQ_wb, "Secchi Site", SP_Site)
  writeData(WQ_wb, "Temp Station", Temp_Station)
  writeData(WQ_wb, "Temp Site", Temp_Site)
  #Save workbook
  saveWorkbook(WQ_wb, "../Data/CERP_PBC_WQ_Summary_Data.xlsx", overwrite=TRUE)
```

```{r Dermo data tables, eval = params$Dermo}
#
##Dermo output summary
Dermo_out <- Dermo_combined %>% dplyr::select(-ShellHeight, -TotalWeight, -ShellWetWeight, -Comments) %>% group_by(StationName, AnalysisDate) %>% summarise(Mean = mean(MeanDermo, na.rm = T)) %>% pivot_wider(names_from = StationName, values_from = Mean)

##Summary by Station
#Create empty data frame with analysis dates
Station_summary_D <- data.frame(AnalysisDate = unique(Dermo_combined$AnalysisDate))
for(j in Station_order){
  Summary_jD <- Dermo_combined %>% dplyr::select(-ShellHeight, -TotalWeight, -ShellWetWeight, -Comments) %>% 
    #Select columns, filter to Station by FixedLocationID, and group for summary
    dplyr::select(StationName, AnalysisDate, RetDate, DermoMantle:DermoSum) %>% filter(StationName == j) %>% group_by(AnalysisDate, RetDate) %>%
    #Calculate Mean, SD, and Pct dermo
    summarise(Mean = mean(MeanDermo, na.rm = T), SD = sd(MeanDermo, na.rm = T), Pct = (sum(DermoSum, na.rm = T)/n())*100) %>%
    #Rename columns: Add StationName to beginning, reformat RetDate for cleaning
    rename_with(.fn = ~ifelse(.x != "AnalysisDate", paste0(j, "_", .x), .x), .cols = -all_of("AnalysisDate")) 
  #
  #Join with existing data
  Station_summary_D <- left_join(Station_summary_D, Summary_jD, by = "AnalysisDate")
  #Clean columns for selection and output
  Station_summ_D <- Station_summary_D %>% dplyr::select(-contains(Date_exclusion)) %>% rename_with(~sub("(\\d)_RetDate", "_RetDate", .x)) %>%
    mutate(across(where(is.numeric), round, 2)) %>% arrange(AnalysisDate)
  }


##Summary by Site
#Create empty data frame with analysis dates
Site_summary_D <- data.frame(AnalysisDate = unique(Dermo_combined$AnalysisDate))
for(j in Sites){
  Summary_jD <- Dermo_combined %>% dplyr::select(-ShellHeight, -TotalWeight, -ShellWetWeight, -Comments) %>% 
    #Select columns for each param, filter to Site, and group for summary
    dplyr::select(Site, AnalysisDate, RetDate, DermoMantle:DermoSum) %>% filter(Site == j) %>% group_by(AnalysisDate, RetDate) %>% 
    #Calculate mean, SD, min, and max of parameter
    summarise(Mean = mean(MeanDermo, na.rm = T), SD = sd(MeanDermo, na.rm = T), Pct = (sum(DermoSum, na.rm = T)/n())*100) %>% 
    #Rename columns: Add Site to beginning, reformat RetDate for cleaning
    rename_with(.fn = ~ifelse(.x != "AnalysisDate", paste0(j, "_", .x), .x), .cols = -all_of("AnalysisDate")) 
  #
  #Join with existing data
  Site_summary_D <- left_join(Site_summary_D, Summary_jD, by = "AnalysisDate")
  #Clean columns for selection and output
  Site_summ_D <- Site_summary_D %>% mutate(across(where(is.numeric), round, 2)) %>% mutate(across(where(is.numeric), ~na_if(.x, Inf))) %>%
    mutate(across(where(is.numeric), ~na_if(.x, -Inf))) %>% arrange(AnalysisDate)
  }
#
#
  #Load each sheet and append new data
  Dermo_Station <- readWorkbook("../Data/CERP_PBC_Summary_Data.xlsx", sheet = 'Dermo Station', detectDates = TRUE) %>% mutate(across(contains("Date"), ~as.Date(.x, format = "%Y-%m-%d")), across(!contains("Date"), ~as.numeric(.x))) %>% bind_rows(Station_summ_D)
  Dermo_Site <- readWorkbook("../Data/CERP_PBC_Summary_Data.xlsx", sheet = 'Dermo Site', detectDates = TRUE) %>% mutate(across(contains("Date"), ~as.Date(.x, format = "%Y-%m-%d")), across(!contains("Date"), ~as.numeric(.x))) %>% bind_rows(Site_summ_D)
  
  #Load workbook of existing data
  Data_wb <- loadWorkbook("../Data/CERP_PBC_Summary_Data.xlsx")
  #Overwrite each sheet with new data appended to old
  writeData(Data_wb, "Dermo Station", Dermo_Station)
  writeData(Data_wb, "Dermo Site", Dermo_Site)
   #Save workbook
  saveWorkbook(Data_wb, "../Data/CERP_PBC_Summary_Data.xlsx", overwrite=TRUE)

```

```{r Cage data tables, eval = params$Cage}
#
#Cage output summary
Cage_out <- Cage_combined %>% dplyr::select(-DeployedDate,-DaysDeployed, -Comments) %>% group_by(StationName, AnalysisDate) %>% summarise(Mean = round(mean(DeadPct, na.rm = T), 2)) %>% pivot_wider(names_from = StationName, values_from = Mean) %>% arrange(AnalysisDate)

##Summary by Cage
#Create empty data frame with analysis dates
Station_summary_C <- data.frame(AnalysisDate = unique(Cage_combined$AnalysisDate)) %>% arrange(AnalysisDate)
for(c in Cage_reps){
  Summary_cC <- Cage_combined %>% dplyr::select(-DeployedDate,-DaysDeployed, -Comments) %>% 
    #Select columns, filter to Station by FixedLocationID, and group for summary
    dplyr::select(CageName, AnalysisDate, DeadPct) %>% filter(CageName == c) %>% group_by(AnalysisDate) %>%
    #Calculate Mean, SD, and Pct dermo
    summarise(DeadPctMean = mean(DeadPct, na.rm = T)) %>%
    #Rename columns: Add StationName to beginning
    rename_with(.fn = ~ifelse(.x != "AnalysisDate", paste0(c, "_", .x), .x), .cols = -all_of("AnalysisDate")) 
  #
  Summary_cSH <- CageSH_combined %>% 
    #Select columns, filter to Station by FixedLocationID, and group for summary
    dplyr::select(CageName, AnalysisDate, RetDate, DataType, ShellHeight) %>% filter(CageName == c) %>% group_by(AnalysisDate, RetDate, DataType) %>%
    #Calculate Mean, SD, and Pct dermo
    summarise(SHMean = mean(ShellHeight, na.rm = T), SHSD = sd(ShellHeight, na.rm = T)) %>%
    #Rename columns & add CageName to beginning
    pivot_wider(names_from = DataType, values_from = c(SHMean, SHSD), names_glue = "{DataType}_{.value}", names_sort = TRUE)  %>%
    dplyr::select(AnalysisDate, RetDate, matches("Dep"), everything()) %>%
    rename_with(.fn = ~ifelse(.x != "AnalysisDate", paste0(c, "_", .x), .x), .cols = -all_of("AnalysisDate")) 
  #
  #Join with existing data
  Station_summary_C <- left_join(Station_summary_C, left_join(Summary_cSH, Summary_cC, by = "AnalysisDate"), by = "AnalysisDate")
  #Clean columns for selection and output
  Station_summ_C <- Station_summary_C %>% dplyr::select(-contains(c("-R_RetDate", "-Y_RetDate"))) %>% rename_with(~sub("-B_RetDate", "_RetDate", .x)) %>% mutate(across(where(is.numeric), round, 2)) %>% arrange(AnalysisDate)
}

##Summary by Site
#Create empty data frame with analysis dates
Site_summary_C <- data.frame(AnalysisDate = unique(Cage_combined$AnalysisDate)) %>% arrange(AnalysisDate)
for(j in Cage_Sites){
  Summary_jC <- Cage_combined  %>% dplyr::select(-DeployedDate,-DaysDeployed, -Comments) %>% 
    #Select columns for each param, filter to Site, and group for summary
    dplyr::select(Site, AnalysisDate, DeadPct) %>% filter(Site == j) %>% group_by(AnalysisDate) %>% 
    #Calculate mean, SD, min, and max of parameter
    summarise(DeadPctMean = mean(DeadPct, na.rm = T), DeadPctSD = sd(DeadPct, na.rm = T)) %>% 
    #Rename columns: Add Site to beginning, reformat RetDate for cleaning
    rename_with(.fn = ~ifelse(.x != "AnalysisDate", paste0(j, "_", .x), .x), .cols = -all_of("AnalysisDate")) 
  #
  Summary_jSH <- CageSH_combined  %>% 
    #Select columns for each param, filter to Site, and group for summary
    dplyr::select(Site, AnalysisDate, DataType, ShellHeight) %>% filter(Site == j) %>% group_by(AnalysisDate, DataType) %>% 
    #Calculate mean, SD, min, and max of parameter
    summarise(SHMean = mean(ShellHeight, na.rm = T), SHSD = sd(ShellHeight, na.rm = T)) %>% 
    #Rename columns: Add Site to beginning, reformat RetDate for cleaning
    pivot_wider(names_from = DataType, values_from = c(SHMean, SHSD), names_glue = "{DataType}_{.value}", names_sort = TRUE)  %>%
    dplyr::select(AnalysisDate, matches("Dep"), everything()) %>%
    rename_with(.fn = ~ifelse(.x != "AnalysisDate", paste0(j, "_", .x), .x), .cols = -all_of("AnalysisDate")) 
  #
  #Join with existing data
  Site_summary_C <- left_join(Site_summary_C, left_join(Summary_jSH, Summary_jC, by = "AnalysisDate"), by = "AnalysisDate")
  #Clean columns for selection and output
  Site_summ_C <- Site_summary_C %>% mutate(across(where(is.numeric), round, 2)) %>% mutate(across(where(is.numeric), ~na_if(.x, Inf))) %>%
    mutate(across(where(is.numeric), ~na_if(.x, -Inf))) %>% arrange(AnalysisDate)
}
#
#
  #Load each sheet and append new data
  SH_Mort_Cage <- readWorkbook("../Data/CERP_PBC_Summary_Data.xlsx", sheet = 'SH Mort Cage', detectDates = TRUE) %>% mutate(across(contains("Date"), ~as.Date(.x, format = "%Y-%m-%d")), across(!contains("Date"), ~as.numeric(.x))) %>% bind_rows(Station_summ_C)
  SH_Mort_Site <- readWorkbook("../Data/CERP_PBC_Summary_Data.xlsx", sheet = 'SH Mort Site', detectDates = TRUE) %>% mutate(across(contains("Date"), ~as.Date(.x, format = "%Y-%m-%d")), across(!contains("Date"), ~as.numeric(.x))) %>% bind_rows(Site_summ_C)
  
  #Load workbook of existing data
  Data_wb <- loadWorkbook("../Data/CERP_PBC_Summary_Data.xlsx")
  #Overwrite each sheet with new data appended to old
  writeData(Data_wb, "SH Mort Cage", SH_Mort_Cage)
  writeData(Data_wb, "SH Mort Site", SH_Mort_Site)
   #Save workbook
  saveWorkbook(Data_wb, "../Data/CERP_PBC_Summary_Data.xlsx", overwrite=TRUE)

```

```{r Recruitment data tables, eval = params$Rcrt}

#Combined table of all parameters
Rcrt_combined <- left_join(rbind((hsdbRcrt %>% filter(DataStatus == "Proofed" | DataStatus == "Completed")), (dboRcrt %>% filter(DataStatus == "Proofed"))) %>%
  #Create date columns 
  mutate(RetDate = as.Date(substring(SampleEventID, 8, 15), format = "%Y%m%d"),
         DeployedDate = as.Date(DeployedDate, format = "%Y-%m-%d"),
         AnalysisDate = as.Date(floor_date(RetDate, unit = "month"))) %>% 
  #Filter data to desired columns needed for summary
  dplyr::select(AnalysisDate, RetDate, DeployedDate, ShellID, SampleEventID, FixedLocationID, ShellReplicate, ShellPosition, NumBottom) %>% #, BottomMonth) %>% 
  #Arrange by station then date
  arrange(match(FixedLocationID, c(LocationID_order)), AnalysisDate),
  #Add simplified StationName 
  dboFixedLocations %>% 
    mutate(StationName = paste0(Estuary, "-", SectionName, StationNumber),
           Site = paste0(Estuary, "-", SectionName)) %>%
    dplyr::select(FixedLocationID, Site, StationName)) %>%
  mutate(Bottom = case_when((Site == "CR-E"|Site == "CR-W") & (ShellPosition == 1 | ShellPosition == 12) ~ NA,
                            (Site %in% c("LW-L", "LW-R", "LX-N", "LX-S", "SL-C", "SL-N", "SL-S")) & (ShellPosition == 1|ShellPosition == 6|ShellPosition == 7|ShellPosition == 12) ~ NA,
                            TRUE ~ NumBottom),
         BottomMonth = Bottom/(as.numeric(RetDate-DeployedDate)/28)) %>%
  dplyr::select(-DeployedDate, -ShellReplicate, -ShellPosition, -NumBottom, -Bottom) %>%
  drop_na(BottomMonth)

##Recruitment output summary
Rcrt_out <- Rcrt_combined %>% group_by(StationName, AnalysisDate) %>% summarise(Mean = round(mean(BottomMonth, na.rm = T),2)) %>% pivot_wider(names_from = StationName, values_from = Mean)

##Summary by Station
#Create empty data frame with analysis dates
Station_summary_R <- data.frame(AnalysisDate = unique(Rcrt_combined$AnalysisDate))
for(j in Station_order){
  Summary_jR <- Rcrt_combined %>% 
    #Select columns, filter to Station by FixedLocationID, and group for summary
    dplyr::select(StationName, AnalysisDate, RetDate, BottomMonth) %>% filter(StationName == j) %>% group_by(AnalysisDate, RetDate) %>%
    #Calculate Mean, SD, and Pct dermo
    summarise(Mean = mean(BottomMonth, na.rm = T), SD = sd(BottomMonth, na.rm = T)) %>%
    #Rename columns: Add StationName to beginning, reformat RetDate for cleaning
    rename_with(.fn = ~ifelse(.x != "AnalysisDate", paste0(j, "_", .x), .x), .cols = -all_of("AnalysisDate")) 
  #
  #Join with existing data
  Station_summary_R <- left_join(Station_summary_R, Summary_jR, by = "AnalysisDate")
  #Clean columns for selection and output
  Station_summ_R <- Station_summary_R %>% dplyr::select(-contains(Date_exclusion)) %>% rename_with(~sub("(\\d)_RetDate", "_RetDate", .x)) %>%
    mutate(across(where(is.numeric), round, 2)) %>% arrange(AnalysisDate)
  }


##Summary by Site
#Create empty data frame with analysis dates
Site_summary_R <- data.frame(AnalysisDate = unique(Rcrt_combined$AnalysisDate))
for(j in Sites){
  Summary_jR <- Rcrt_combined  %>% 
    #Select columns for each param, filter to Site, and group for summary
    dplyr::select(Site, AnalysisDate, RetDate, BottomMonth) %>% filter(Site == j) %>% group_by(AnalysisDate, RetDate) %>% 
    #Calculate mean, SD, min, and max of parameter
    summarise(Mean = mean(BottomMonth, na.rm = T), SD = sd(BottomMonth, na.rm = T)) %>% 
    #Rename columns: Add Site to beginning, reformat RetDate for cleaning
    rename_with(.fn = ~ifelse(.x != "AnalysisDate", paste0(j, "_", .x), .x), .cols = -all_of("AnalysisDate")) 
  #
  #Join with existing data
  Site_summary_R <- left_join(Site_summary_R, Summary_jR, by = "AnalysisDate")
  #Clean columns for selection and output
  Site_summ_R <- Site_summary_R %>% mutate(across(where(is.numeric), round, 2)) %>% mutate(across(where(is.numeric), ~na_if(.x, Inf))) %>%
    mutate(across(where(is.numeric), ~na_if(.x, -Inf))) %>% arrange(AnalysisDate)
  }
#
#
  #Load each sheet and append new data
  Rcrt_Station <- readWorkbook("../Data/CERP_PBC_Summary_Data.xlsx", sheet = 'Rcrt Station', detectDates = TRUE) %>% mutate(across(contains("Date"), ~as.Date(.x, format = "%Y-%m-%d")), across(!contains("Date"), ~as.numeric(.x))) %>% bind_rows(Station_summ_R)
  Rcrt_Site <- readWorkbook("../Data/CERP_PBC_Summary_Data.xlsx", sheet = 'Rcrt Site', detectDates = TRUE) %>% mutate(across(contains("Date"), ~as.Date(.x, format = "%Y-%m-%d")), across(!contains("Date"), ~as.numeric(.x))) %>% bind_rows(Site_summ_R)
  
  #Load workbook of existing data
  Data_wb <- loadWorkbook("../Data/CERP_PBC_Summary_Data.xlsx")
  #Overwrite each sheet with new data appended to old
  writeData(Data_wb, "Rcrt Station", Rcrt_Station)
  writeData(Data_wb, "Rcrt Site", Rcrt_Site)
   #Save workbook
  saveWorkbook(Data_wb, "../Data/CERP_PBC_Summary_Data.xlsx", overwrite=TRUE)

```

```{r Repro data tables, eval = params$Repro}
#
#List of Repro stages
Stages <- c("Ind", "Dev","Rip", "Spe")

#Combined table of all parameters
Repro_combined <- left_join(rbind((hsdbRepro %>% dplyr::select(-OldSampleNumber) %>% filter(DataStatus == "Proofed" | DataStatus == "Completed")), (dboRepro %>% filter(DataStatus == "Proofed"))) %>%
  #Create date columns 
  mutate(RetDate = as.Date(substring(SampleEventID, 8, 15), format = "%Y%m%d"),
         AnalysisDate = as.Date(floor_date(RetDate, unit = "month")),
         ReproStage = as.factor(ReproStage)) %>%
  #Filter data to desired date range and select columns needed for summary
  dplyr::select(AnalysisDate, RetDate, OysterID, SampleEventID, FixedLocationID, ReproStage) %>% 
  #Arrange by station then date
  arrange(match(FixedLocationID, c(LocationID_order)), AnalysisDate),
  #Add simplified StationName 
  dboFixedLocations %>% 
    mutate(StationName = paste0(Estuary, "-", SectionName, StationNumber),
           Site = paste0(Estuary, "-", SectionName)) %>%
    dplyr::select(FixedLocationID, Site, StationName)) %>%
  filter(as.numeric(substr(OysterID, nchar(OysterID)-1, nchar(OysterID))) < 16)

##Repro output summary (Developing or Ripe Oysters)
Repro_out <- left_join(Repro_combined %>% group_by(Site, AnalysisDate) %>% filter(ReproStage == "1" | ReproStage == "2") %>% summarise(Count = n()), Repro_combined %>% group_by(Site, AnalysisDate) %>% summarise(Total = n()))  %>%  mutate(Pct = round((Count/Total)*100,2)) %>% dplyr::select(-Count, -Total) %>% pivot_wider(names_from = Site, values_from = Pct) %>% arrange(AnalysisDate) %>% mutate(across(everything(), ~replace_na(., 0)))


##Summary by Site
#Create empty data frame with analysis dates
Site_summary_Re <- data.frame(AnalysisDate = unique(Repro_combined$AnalysisDate))
for(j in Sites){
  for(s in Stages){
    Repro_comb <- Repro_combined %>% mutate(ReproStage = factor(ReproStage, levels = c("1", "2", "3", "4", "Z"), labels = c("Dev", "Rip", "Spe", "Ind", "Z"))) %>% mutate(ReproStage2 = fct_relevel(ReproStage, "Ind", "Dev", "Rip", "Spe", "Z")) %>% filter(ReproStage != "Z")
    Repro_RetDates <- Repro_comb %>% filter(Site == j) %>% distinct(AnalysisDate, RetDate) %>% rename_with(.fn = ~ifelse(.x != "AnalysisDate", paste0(j, "_", .x), .x))
    Summary_jRe <- left_join(Repro_comb  %>% 
                               #Select columns, filter to Station by FixedLocationID, and group by ReproStage for Count
                               dplyr::select(Site, AnalysisDate, ReproStage) %>% filter(Site == j & ReproStage == s) %>% group_by(AnalysisDate, ReproStage) %>% summarise(Count = n()), 
                             Repro_comb %>% 
                               #Repeat for total number of samples
                               dplyr::select(Site, AnalysisDate, ReproStage) %>% filter(Site == j) %>% group_by(AnalysisDate) %>%
                               summarise(Total = n())) %>%
      #Determine percent, remove any "Z"s
      mutate(Pct = (Count/Total)*100) %>% dplyr::select(-Count, -Total) %>%
      rename_with(., function(x){str_replace(x, "Pct",s)}) %>%
      #Rename columns: Add Site to beginning
      rename_with(.fn = ~ifelse(.x != "AnalysisDate", paste0(j, "_", .x), .x), .cols = -all_of("AnalysisDate")) %>% dplyr::select(-paste0(j,"_ReproStage"))
    #
    #Join with existing data
    Site_summary_Re <- left_join(Site_summary_Re, left_join(Repro_RetDates, Summary_jRe), by = "AnalysisDate")
  }
  #Clean columns for selection and output
  Site_summ_Re <- Site_summary_Re %>% mutate(across(where(is.numeric), round, 2)) %>% mutate(across(where(is.numeric), ~na_if(.x, Inf))) %>%
    mutate(across(where(is.numeric), ~na_if(.x, -Inf))) %>% 
    #Remove unneeded columns and rename/clean remaining
    dplyr::select(-ends_with(c(".y",".x.x"))) %>% rename_with(~sub("RetDate.x", "RetDate", .x)) %>% mutate(across(where(is.numeric), ~replace(., is.na(.), 0))) %>% arrange(AnalysisDate)
}
#
#
  #Load each sheet and append new data
  Repro_Site <- readWorkbook("../Data/CERP_PBC_Summary_Data.xlsx", sheet = 'Repro', detectDates = TRUE) %>% mutate(across(contains("Date"), ~as.Date(.x, format = "%Y-%m-%d")), across(!contains("Date"), ~as.numeric(.x))) %>% bind_rows(Site_summ_Re)
  
  #Load workbook of existing data
  Data_wb <- loadWorkbook("../Data/CERP_PBC_Summary_Data.xlsx")
  #Overwrite each sheet with new data appended to old
  writeData(Data_wb, "Repro", Repro_Site)
   #Save workbook
  saveWorkbook(Data_wb, "../Data/CERP_PBC_Summary_Data.xlsx", overwrite=TRUE)

```

```{r Sediment trap data tables, eval = params$Sedi}
Sedi_Sites <- c("LW-L", "LW-R")
Sedi_order <- c("LW-L1", "LW-L2", "LW-L3", "LW-R2", "LW-R3", "LW-R4")
Positions <- c("North", "South")
NorthStations <- c("0312", "0235", "0236")
SouthStations <- c("0240", "0241", "0237")

#Combined table of all parameters
Sedi_combined <- left_join(rbind((hsdbSedi %>% filter(DataStatus == "Proofed" | DataStatus == "Completed")), (dboSedi %>% filter(DataStatus == "Proofed"))) %>%
  #Create date columns 
  mutate(RetDate = as.Date(substring(SampleEventID, 8, 15), format = "%Y%m%d"),
         DeployedDate = as.Date(DeployedDate, format = "%Y-%m-%d"),
         AnalysisDate = as.Date(floor_date(RetDate, unit = "month")),
         Position = case_when(FixedLocationID %in% NorthStations ~ "North",
                             FixedLocationID %in% SouthStations ~ "South",
                             TRUE ~ NA),
         TotalDW = (PanDryWeight - PanTareWeight) + (FilterDryWeight - FilterTareWeight),
         Proportion = round((CrucibleDW-TareCrucible)/((PanDryWeight - PanTareWeight) + (FilterDryWeight - FilterTareWeight)),3),
         TotalAsh = case_when(is.na(Proportion) ~(AshWeight - TareCrucible)*(1/PortionofSample), TRUE ~ (AshWeight - TareCrucible)*(1/Proportion)),
         PctOrganic = ((TotalDW-round(TotalAsh,3))/TotalDW)*100,
         OrganicWt = TotalDW*(PctOrganic/100)) %>%
  #Filter data to desired columns needed for summary
  dplyr::select(AnalysisDate, RetDate, DeployedDate, CupSampleID, SampleEventID, FixedLocationID, Position, TotalDW, PctOrganic, OrganicWt) %>% 
  #Arrange by station then date
  arrange(match(FixedLocationID, c(LocationID_order)), AnalysisDate),
  #Add simplified StationName 
  dboFixedLocations %>% 
    mutate(StationName = paste0(Estuary, "-", SectionName, StationNumber),
           Site = paste0(Estuary, "-", SectionName)) %>%
    dplyr::select(FixedLocationID, Site, StationName)) %>% filter(Site %in% Sedi_Sites)

##Sediment output summary
Sedi_out <- Sedi_combined %>% group_by(StationName, AnalysisDate) %>% summarise(Mean = round(mean(TotalDW, na.rm = T),2)) %>% pivot_wider(names_from = StationName, values_from = Mean)

##Summary by Station
#Create empty data frame with analysis dates
Station_summary_D <- data.frame(AnalysisDate = unique(Sedi_combined$AnalysisDate))
for(j in Sedi_order){
  Summary_jD <- Sedi_combined %>% 
    #Select columns, filter to Station by FixedLocationID, and group for summary
    dplyr::select(StationName, AnalysisDate, RetDate, DeployedDate, TotalDW:OrganicWt) %>% filter(StationName == j) %>% group_by(AnalysisDate, RetDate) %>%
    #Calculate Mean, SD, and Pct dermo
    summarise(RateMean = mean(TotalDW/(as.integer(RetDate-DeployedDate)/28), na.rm = T),
              RateSD = sd(TotalDW/(as.integer(RetDate-DeployedDate)/28), na.rm = T),
              PctOrganicMean = mean(PctOrganic, na.rm = T),
              PctOrganicSD = sd(PctOrganic, na.rm = T),
              OrgWtMean = mean(OrganicWt/(as.integer(RetDate-DeployedDate)/28), na.rm = T),
              OrgWtSD = sd(OrganicWt/(as.integer(RetDate-DeployedDate)/28), na.rm = T)) %>%
    #Rename columns: Add StationName to beginning, reformat RetDate for cleaning
    rename_with(.fn = ~ifelse(.x != "AnalysisDate", paste0(j, "_", .x), .x), .cols = -all_of("AnalysisDate")) 
  #
  #Join with existing data
  Station_summary_D <- left_join(Station_summary_D, Summary_jD, by = "AnalysisDate")
  #Clean columns for selection and output
  Station_summ_D <- Station_summary_D %>% dplyr::select(-matches("L2_Ret|L3_Ret|R3_Ret|R4_Ret")) %>% rename_with(~sub("(\\d)_RetDate", "_RetDate", .x)) %>%
    mutate(across(where(is.numeric), round, 2)) %>% arrange(AnalysisDate)
  }


##Summary by Position
#Create empty data frame with analysis dates
Site_summary_D <- data.frame(AnalysisDate = unique(Sedi_combined$AnalysisDate))
for(p in Positions){
  Summary_jD <- Sedi_combined  %>% 
    #Select columns for each param, filter to Position, and group for summary
    dplyr::select(Position, AnalysisDate, RetDate, DeployedDate, TotalDW:OrganicWt) %>% filter(Position == p) %>% group_by(AnalysisDate, RetDate) %>% 
    #Calculate mean, SD, min, and max of parameter
    summarise(RateMean = mean(TotalDW/(as.integer(RetDate-DeployedDate)/28), na.rm = T),
              RateSD = sd(TotalDW/(as.integer(RetDate-DeployedDate)/28), na.rm = T),
              PctOrganicMean = mean(PctOrganic, na.rm = T),
              PctOrganicSD = sd(PctOrganic, na.rm = T),
              OrgWtMean = mean(OrganicWt/(as.integer(RetDate-DeployedDate)/28), na.rm = T),
              OrgWtSD = sd(OrganicWt/(as.integer(RetDate-DeployedDate)/28), na.rm = T)) %>% 
    #Rename columns: Add Site to beginning, reformat RetDate for cleaning
    rename_with(.fn = ~ifelse(.x != "AnalysisDate", paste0(p, "_", .x), .x), .cols = -all_of("AnalysisDate")) 
  #
  #Join with existing data
  Site_summary_D <- left_join(Site_summary_D, Summary_jD, by = "AnalysisDate")
  #Clean columns for selection and output
  Site_summ_D <- Site_summary_D %>% dplyr::select(-matches("South_Ret")) %>% mutate(across(where(is.numeric), round, 2)) %>% mutate(across(where(is.numeric), ~na_if(.x, Inf))) %>%
    mutate(across(where(is.numeric), ~na_if(.x, -Inf))) %>% arrange(AnalysisDate)
  }
#
#
  #Load each sheet and append new data
  Sedi_Station <- readWorkbook("../Data/CERP_PBC_Summary_Data.xlsx", sheet = 'Sedi Stations', detectDates = TRUE) %>% bind_rows(Station_summ_D)
  Sedi_Site <- readWorkbook("../Data/CERP_PBC_Summary_Data.xlsx", sheet = 'Sedi Position', detectDates = TRUE) %>% bind_rows(Site_summ_D)
  
  #Load workbook of existing data
  Data_wb <- loadWorkbook("../Data/CERP_PBC_Summary_Data.xlsx")
  #Overwrite each sheet with new data appended to old
  writeData(Data_wb, "Sedi Stations", Sedi_Station)
  writeData(Data_wb, "Sedi Position", Sedi_Site)
   #Save workbook
  saveWorkbook(Data_wb, "../Data/CERP_PBC_Summary_Data.xlsx", overwrite=TRUE)

```

```{r Survey data tables, eval = params$Srvy}
#
#Survey output summary
Srvy_out <- Srvy_combined %>% group_by(StationName, AnalysisDate) %>% summarise(Mean = round(mean(Live, na.rm = T), 2)) %>% pivot_wider(names_from = StationName, values_from = Mean) %>% mutate(Survey = paste0(case_when(month(AnalysisDate) <= 3 ~ "Spring ", month(AnalysisDate) > 3 & month(AnalysisDate) <= 6 ~ "Summer ", month(AnalysisDate) > 6 & month(AnalysisDate) <= 9 ~ "Fall ", month(AnalysisDate) > 9 ~ "Winter ", TRUE ~ "UNK"), year(AnalysisDate)), .before = AnalysisDate)

##Summary by Station
Station_summary_S <- data.frame(AnalysisDate = unique(Srvy_combined$AnalysisDate))
#Create empty data frame with analysis dates
for(j in Station_order){
  Summary_jS <- Srvy_combined %>% 
    #Select columns, filter to Station by FixedLocationID, and group for summary
    dplyr::select(StationName, AnalysisDate, Live, Dead, DeadRatio) %>% filter(StationName == j) %>% group_by(AnalysisDate) %>%
    #Calculate Mean, SD, and Pct dermo
    summarise(LiveMean = mean(Live, na.rm = T), LiveSD = sd(Live, na.rm = T), DeadRatioMean = mean(DeadRatio, na.rm = T), DeadRatioSD = sd(DeadRatio, na.rm = T))  %>%
    #Rename columns: Add StationName to beginning
    rename_with(.fn = ~ifelse(.x != "AnalysisDate", paste0(j, "_", .x), .x), .cols = -all_of("AnalysisDate")) 
  #
  #Join with existing data
  Station_summary_S <- left_join(Station_summary_S, Summary_jS, by = "AnalysisDate")
  #Clean columns for selection and output
  Station_summ_S <- Station_summary_S %>% mutate(across(where(is.numeric), round, 2)) %>% mutate(Survey = paste0(case_when(month(AnalysisDate) <= 3 ~"Spring ", month(AnalysisDate) > 3 & month(AnalysisDate) <= 6 ~ "Summer ", month(AnalysisDate) > 6 & month(AnalysisDate) <= 9 ~ "Fall ", month(AnalysisDate) > 9 ~ "Winter ", TRUE ~ "UNK"), year(AnalysisDate)), .before = AnalysisDate)  %>% arrange(AnalysisDate)
}

Station_summary_SH <- data.frame(AnalysisDate = unique(Srvy_combined$AnalysisDate))
for(j in Station_order){
  Summary_jSH <- SH_combined %>% 
    #Select columns, filter to Station by FixedLocationID, and group for summary
    dplyr::select(StationName, AnalysisDate, ShellHeight) %>% filter(StationName == j) %>% group_by(AnalysisDate) %>%
    #Calculate Mean, SD, and Pct dermo
    summarise(SHMean = mean(ShellHeight, na.rm = T), SHSD = sd(ShellHeight, na.rm = T)) %>%
    #Rename columns: Add StationName to beginning
    rename_with(.fn = ~ifelse(.x != "AnalysisDate", paste0(j, "_", .x), .x), .cols = -all_of("AnalysisDate")) 
  #
  #Join with existing data
  Station_summary_SH <- left_join(Station_summary_SH, Summary_jSH, by = "AnalysisDate")
  #Clean columns for selection and output
  Station_summ_SH <- Station_summary_SH %>% mutate(across(where(is.numeric), round, 2)) %>% mutate(Survey = paste0(case_when(month(AnalysisDate) <= 3 ~ "Spring ", month(AnalysisDate) > 3 & month(AnalysisDate) <= 6 ~ "Summer ", month(AnalysisDate) > 6 & month(AnalysisDate) <= 9 ~ "Fall ", month(AnalysisDate) > 9 ~ "Winter ", TRUE ~ "UNK"), year(AnalysisDate)), .before = AnalysisDate) %>% arrange(AnalysisDate)
}

##Summary by Site
#Create empty data frame with analysis dates
Site_summary_S <- data.frame(AnalysisDate = unique(Srvy_combined$AnalysisDate))
for(j in Sites){
  Summary_jS <- Srvy_combined  %>% 
     #Mutate to remove extra SHs from Site
     mutate(Live = case_when((StationName == "CR-E1" | StationName == "CR-W4") & month(RetDate) == 6 ~ NA, (StationName == "CR-E1" | StationName == "CR-W4") & month(RetDate) == 12 ~ NA, TRUE ~ Live),
            Dead = case_when((StationName == "CR-E1" | StationName == "CR-W4") & month(RetDate) == 6 ~ NA, (StationName == "CR-E1" | StationName == "CR-W4") & month(RetDate) == 12 ~ NA, TRUE ~ Dead),
            DeadRatio = case_when((StationName == "CR-E1" | StationName == "CR-W4") & month(RetDate) == 6 ~ NA, (StationName == "CR-E1" | StationName == "CR-W4") & month(RetDate) == 12 ~ NA, TRUE ~ DeadRatio)) %>% 
    #Select columns for each param, filter to Site, and group for summary
    dplyr::select(Site, AnalysisDate, Live, Dead, DeadRatio) %>% filter(Site == j) %>% group_by(AnalysisDate) %>% 
    #Calculate mean, SD, min, and max of parameter
    summarise(LiveMean = mean(Live, na.rm = T), LiveSD = sd(Live, na.rm = T), DeadMean = mean(DeadRatio, na.rm = T), DeadSD = sd(DeadRatio, na.rm = T)) %>% 
    #Rename columns: Add Site to beginning, reformat RetDate for cleaning
    rename_with(.fn = ~ifelse(.x != "AnalysisDate", paste0(j, "_", .x), .x), .cols = -all_of("AnalysisDate")) 
  #
  #Join with existing data
  Site_summary_S <- left_join(Site_summary_S, Summary_jS, by = "AnalysisDate")
  #Clean columns for selection and output
  Site_summ_S <- Site_summary_S %>% mutate(across(where(is.numeric), round, 2)) %>% mutate(across(where(is.numeric), ~na_if(.x, Inf))) %>%
    mutate(across(where(is.numeric), ~na_if(.x, -Inf))) %>% mutate(Survey = paste0(case_when(month(AnalysisDate) <= 3 ~ "Spring ", month(AnalysisDate) > 3 & month(AnalysisDate) <= 6 ~ "Summer ", month(AnalysisDate) > 6 & month(AnalysisDate) <= 9 ~ "Fall ", month(AnalysisDate) > 9 ~ "Winter ", TRUE ~ "UNK"), year(AnalysisDate)), .before = AnalysisDate) %>% arrange(AnalysisDate)
}

Site_summary_SH <- data.frame(AnalysisDate = unique(Srvy_combined$AnalysisDate))
for(j in Sites){
  Summary_jSH <- SH_combined  %>% 
    #Mutate to remove extra SHs from Site
     mutate(ShellHeight = case_when((StationName == "CR-E1" | StationName == "CR-W4") & month(RetDate) == 6 ~ NA, (StationName == "CR-E1" | StationName == "CR-W4") & month(RetDate) == 12 ~ NA, TRUE ~ ShellHeight)) %>% 
    #Select columns for each param, filter to Site, and group for summary
    dplyr::select(Site, AnalysisDate, ShellHeight) %>% filter(Site == j) %>% group_by(AnalysisDate) %>% 
    #Calculate mean, SD, min, and max of parameter
    summarise(SHMean = mean(ShellHeight, na.rm = T), SHSD = sd(ShellHeight, na.rm = T)) %>% 
    #Rename columns: Add Site to beginning, reformat RetDate for cleaning
    rename_with(.fn = ~ifelse(.x != "AnalysisDate", paste0(j, "_", .x), .x), .cols = -all_of("AnalysisDate")) 
  #
  #Join with existing data
  Site_summary_SH <- left_join(Site_summary_SH, Summary_jSH, by = "AnalysisDate")
  #Clean columns for selection and output
  Site_summ_SH <- Site_summary_SH %>% mutate(across(where(is.numeric), round, 2)) %>% mutate(across(where(is.numeric), ~na_if(.x, Inf))) %>%
    mutate(across(where(is.numeric), ~na_if(.x, -Inf))) %>% mutate(Survey = paste0(case_when(month(AnalysisDate) <= 3 ~ "Spring ", month(AnalysisDate) > 3 & month(AnalysisDate) <= 6 ~ "Summer ", month(AnalysisDate) > 6 & month(AnalysisDate) <= 9 ~ "Fall ", month(AnalysisDate) > 9 ~ "Winter ", TRUE ~ "UNK"), year(AnalysisDate)), .before = AnalysisDate) %>% arrange(AnalysisDate)
  }
#
#
  #Load each sheet and append new data
  DeadRatio_Station <- readWorkbook("../Data/CERP_PBC_Summary_Data.xlsx", sheet = 'DeadRatio Station', detectDates = TRUE) %>% mutate(across(contains("Date"), ~as.Date(.x, format = "%Y-%m-%d")), across(!contains(c("Date", "Survey")), ~as.numeric(.x))) %>% bind_rows(Station_summ_S)
  DeadRatio_Site <- readWorkbook("../Data/CERP_PBC_Summary_Data.xlsx", sheet = 'DeadRatio Site', detectDates = TRUE) %>% mutate(across(contains("Date"), ~as.Date(.x, format = "%Y-%m-%d")), across(!contains(c("Date", "Survey")), ~as.numeric(.x))) %>% bind_rows(Site_summ_S)
  SH_Station <- readWorkbook("../Data/CERP_PBC_Summary_Data.xlsx", sheet = 'SH Station', detectDates = TRUE) %>% mutate(across(contains("Date"), ~as.Date(.x, format = "%Y-%m-%d")), across(!contains(c("Date", "Survey")), ~as.numeric(.x))) %>% bind_rows(Station_summ_SH)
  SH_Site <- readWorkbook("../Data/CERP_PBC_Summary_Data.xlsx", sheet = 'SH Site', detectDates = TRUE) %>% mutate(across(contains("Date"), ~as.Date(.x, format = "%Y-%m-%d")), across(!contains(c("Date", "Survey")), ~as.numeric(.x))) %>% bind_rows(Site_summ_SH)
  
  #Load workbook of existing data
  Data_wb <- loadWorkbook("../Data/CERP_PBC_Summary_Data.xlsx")
  #Overwrite each sheet with new data appended to old
  writeData(Data_wb, "DeadRatio Station", DeadRatio_Station)
  writeData(Data_wb, "DeadRatio Site", DeadRatio_Site)
  writeData(Data_wb, "SH Station", SH_Station)
  writeData(Data_wb, "SH Site", SH_Site)
   #Save workbook
  saveWorkbook(Data_wb, "../Data/CERP_PBC_Summary_Data.xlsx", overwrite=TRUE)

```

```{r Raw data output, eval = params$Raw_data}
#
#Load each sheet and append new data
  WQ_raw <- readWorkbook("../Data/CERP_PBC_Raw_Data.xlsx", sheet = 'WaterQuality', detectDates = TRUE) %>% mutate(across(contains("RetDate"), ~as.Date(.x, format = "%m/%d/%Y")), across(!contains(c("RetDate","Site", "CollectionTime", "ChlA")), ~as.numeric(.x))) %>% mutate(RetDate = format(RetDate, "%m/%d/%Y")) %>% bind_rows(WQ_raw_data) %>% arrange(Year, Month)
  Dermo_raw <- readWorkbook("../Data/CERP_PBC_Raw_Data.xlsx", sheet = 'Dermo', detectDates = TRUE) %>% mutate(across(contains("RetDate"), ~as.Date(.x, format = "%m/%d/%Y")), across(!contains(c("RetDate","Site", "Comments")), ~as.numeric(.x))) %>% mutate(RetDate = format(RetDate, "%m/%d/%Y")) %>% bind_rows(Dermo_raw_data) %>% arrange(Year, Month)
  Cage_counts_raw <- readWorkbook("../Data/CERP_PBC_Raw_Data.xlsx", sheet = 'CageCounts', detectDates = TRUE) %>% mutate(across(contains("Date"), ~as.Date(.x, format = "%m/%d/%Y")), across(!contains(c("Date","Site","Cage", "Comments")), ~as.numeric(.x))) %>% mutate(DeployedDate = format(DeployedDate, "%m/%d/%Y"), RetDate = format(RetDate, "%m/%d/%Y")) %>% bind_rows(Cage_counts_raw_data) %>% arrange(Year, Month)
  Cage_SH_raw <- readWorkbook("../Data/CERP_PBC_Raw_Data.xlsx", sheet = 'CageSHs', detectDates = TRUE) %>% mutate(across(contains("Date"), ~as.Date(.x, format = "%m/%d/%Y")), across(!contains(c("Date","Site","Cage", "ShellHeightID")), ~as.numeric(.x))) %>% mutate(DeployedDate = format(DeployedDate, "%m/%d/%Y"), RetDate = format(RetDate, "%m/%d/%Y")) %>% bind_rows(Cage_SH_raw_data) %>% arrange(Year, Month, Site, Cage)
  Rcrt_raw <- readWorkbook("../Data/CERP_PBC_Raw_Data.xlsx", sheet = 'Rcrt', detectDates = TRUE) %>% mutate(across(contains("Date"), ~as.Date(.x, format = "%m/%d/%Y")), across(!contains(c("Date","Site","Cage", "Comments")), ~as.numeric(.x))) %>% mutate(RetDate = format(RetDate, "%m/%d/%Y")) %>% bind_rows(Rcrt_raw_data)  %>% arrange(Year, Month, Site, Station, Rep, Shell)
  Repro_raw <- readWorkbook("../Data/CERP_PBC_Raw_Data.xlsx", sheet = 'Repro', detectDates = TRUE) %>% mutate(across(contains("Date"), ~as.Date(.x, format = "%m/%d/%Y"))) %>% mutate(RetDate = format(RetDate, "%m/%d/%Y")) %>% bind_rows(Repro_raw_data)  %>% arrange(RetDate)  %>% arrange(Year, Month)
  Srvy_counts_raw <- readWorkbook("../Data/CERP_PBC_Raw_Data.xlsx", sheet = 'SrvyCounts', detectDates = TRUE) %>% mutate(across(contains("Date"), ~as.Date(.x, format = "%m/%d/%Y"))) %>% mutate(RetDate = format(RetDate, "%m/%d/%Y")) %>% bind_rows(Srvy_counts_raw_data)  %>% arrange(Year, Month)
  Srvy_SH_raw <- readWorkbook("../Data/CERP_PBC_Raw_Data.xlsx", sheet = 'SrvySHs', detectDates = TRUE) %>% mutate(across(contains("Date"), ~as.Date(.x, format = "%m/%d/%Y"))) %>% mutate(RetDate = format(RetDate, "%m/%d/%Y")) %>% bind_rows(Srvy_SH_raw_data)  %>% arrange(Year, Month)
  
  #Load workbook of existing data
  Raw_data_wb <- loadWorkbook("../Data/CERP_PBC_Raw_Data.xlsx")
  #Overwrite each sheet with new data appended to old
  writeData(Raw_data_wb, "WaterQuality", WQ_raw)
  writeData(Raw_data_wb, "Dermo", Dermo_raw)
  writeData(Raw_data_wb, "CageCounts", Cage_counts_raw)
  writeData(Raw_data_wb, "CageSHs", Cage_SH_raw)
  writeData(Raw_data_wb, "Rcrt", Rcrt_raw)
  writeData(Raw_data_wb, "Repro", Repro_raw)
  writeData(Raw_data_wb, "SrvyCounts", Srvy_counts_raw)
  writeData(Raw_data_wb, "SrvySHs", Srvy_SH_raw)

  #Save workbook
  saveWorkbook(Raw_data_wb, "../Data/CERP_PBC_Raw_Data.xlsx", overwrite=TRUE)

```

```{r ReportText}
#Report Text in area below
```
## Report summary
This data summary was compiled by `r Author` on `r format(Sys.Date(), "%d %B %Y")` and summarizes data for **CERP** and **PBC** sites from `r format(Start_date, "%d %B %Y")` through `r format(End_date, "%d %B %Y")` . Mean values are shown.\


## Water Quality summary
Water quality data covers sites and stations from `r if(exists("WQ_combined") == TRUE){min(WQ_combined$AnalysisDate) %>% format("%B %Y")} else {paste0("--")}` through `r if(exists("WQ_combined") == TRUE){max(WQ_combined$AnalysisDate) %>% format("%B %Y")} else {paste0("--")}`.
`r if(exists("WQ_combined") == TRUE){kable(WQ_out_list[1], caption = "Dissovled oxygen data")}`
`r if(exists("WQ_combined") == TRUE){kable(WQ_out_list[2], caption = "Percent dissovled oxygen data")}`
`r if(exists("WQ_combined") == TRUE){kable(WQ_out_list[3], caption = "pH data")}`
`r if(exists("WQ_combined") == TRUE){kable(WQ_out_list[4], caption = "Salinity data")}`
`r if(exists("WQ_combined") == TRUE){kable(WQ_out_list[5], caption = "Secchi penetration data")}`
`r if(exists("WQ_combined") == TRUE){kable(WQ_out_list[6], caption = "Temperature data")}`

## Dermo summary
Dermo data covers sites and stations from `r if(exists("Dermo_combined") == TRUE){min(Dermo_combined$AnalysisDate) %>% format("%B %Y")}else{paste0("--")}` through `r if(exists("Dermo_combined") == TRUE){max(Dermo_combined$AnalysisDate) %>% format("%B %Y")} else {paste0("--")}`.\
`r if(exists("Dermo_combined") == TRUE){kable(Dermo_out, caption = "Dermo data")}`

## Cage summary
Cage data covers sites and stations from `r if(exists("Cage_combined") == TRUE){min(Cage_combined$AnalysisDate) %>% format("%B %Y")} else {paste0("--")}` through `r if(exists("WQ_combined") == TRUE){max(Cage_combined$AnalysisDate) %>% format("%B %Y")} else {paste0("--")}`.\
`r if(exists("Cage_combined") == TRUE){kable(Cage_out, caption = "Cage percent mortatily data. Cage percentages are average mortality per site.")}`

## Recruitment summary
Recruitment data covers sites and stations from `r if(exists("Rcrt_combined") == TRUE){min(Rcrt_combined$AnalysisDate) %>% format("%B %Y")} else {paste0("--")}` through `r if(exists("Rcrt_combined") == TRUE){max(Rcrt_combined$AnalysisDate) %>% format("%B %Y")} else {paste0("--")}`.\
`r if(exists("Rcrt_combined") == TRUE){kable(Rcrt_out, caption = "Recruitment data")}`

## Repro summary
Repro data covers sites and stations from `r if(exists("Repro_combined") == TRUE){min(Repro_combined$AnalysisDate) %>% format("%B %Y")} else {paste0("--")}` through `r if(exists("Repro_combined") == TRUE){max(Repro_combined$AnalysisDate) %>% format("%B %Y")} else {paste0("--")}`.\
`r if(exists("Repro_combined") == TRUE){kable(Repro_out, caption = "Repro percent developing & ripe data.  Percentages are given as total percentage of Developing and Ripe oysters.")}`

## Sediment trap summary
Sediment trap data covers sites and stations (`r if(exists("Sedi_combined") == TRUE){Sedi_Sites}`) from `r if(exists("Sedi_combined") == TRUE){min(Sedi_combined$AnalysisDate) %>% format("%B %Y")} else {paste0("--")}` through `r if(exists("Sedi_combined") == TRUE){max(Sedi_combined$AnalysisDate) %>% format("%B %Y")} else {paste0("--")}`.\
`r if(exists("Sedi_combined") == TRUE){kable(Sedi_out, caption = "Sediment trap total dry weight data. Values provided are mean total dry weight (g).")}`


## Survey summary
Survey data covers sites and stations from `r if(exists("Srvy_combined") == TRUE){min(Srvy_combined$AnalysisDate) %>% format("%B %Y")} else {paste0("--")}` through `r if(exists("Srvy_combined") == TRUE){max(Srvy_combined$AnalysisDate) %>% format("%B %Y")} else {paste0("--")}`.\
`r if(exists("Srvy_combined") == TRUE){kable(Srvy_out, caption = "Survey data. Values provided are mean number of live oysters (per m2).")}`