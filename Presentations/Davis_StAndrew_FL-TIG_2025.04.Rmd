---
title: "Davis_StAndrew_FL-TIG_2025.04"
output: html_document
---

### This is code for creating the data for a presentation to the St. Andrew and St Joe Bay Estuary Program (SASJBEP) Technical Committee Meeting in Panama City, FL. See Powerpoint with the same name as this file for finished result. End product is an Excel file that can create a graph via Pivot Graphs.

```{r VariableSet, echo = FALSE, warning = FALSE, message = FALSE}
# Set your variables
ReportEnd <- as.Date("2024-12-31")  # Report End Date, currently no filter is set to use this. May need to modify somewhere
Database = "OysterLocalMD20250325"  # Set the local database to use
Server = "localhost\\LOCALSQL" # Set the local Server to use
YearFilter = c(2023, 2024) # Data shared in presentation is 2023 only. Adjust here to show other years
```

```{r PackageLoad, echo = FALSE, warning = FALSE, message = FALSE}
# Load necessary R packages
library(tidyverse)
library(odbc)
library(DBI)
library(dbplyr)
library(lubridate)
library(knitr)
library(ggpubr)
library(patchwork) #Required for arranging multiple plots, more flexible
library(scales)
library(openxlsx)
```

```{r ConfigureChunks, warning=FALSE, include=FALSE}
# Configure chunks
knitr::opts_chunk$set(
	echo = FALSE,
	fig.height = 10,
	fig.width = 8,
	message = FALSE,
	warning = FALSE
)

Estuaries <- c("AB", "SA", "PE")
```

```{r DatabaseDownload}
# Connect to Local database server and pull all necessary data, then close connection 
# Note that All data through the end of 2023 has been completed, so querying dbo tables wasn't necessary
con <- dbConnect(odbc(),
                    Driver = "SQL Server", 
                    Server = Server,
                    Database = Database,
                    Authentication = "ActiveDirectoryIntegrated")

dboFixedLocations <- tbl(con,in_schema("dbo", "FixedLocations")) %>%
  collect() %>% 
  filter(Estuary %in% Estuaries)

hsdbWaterQuality <- tbl(con,in_schema("hsdb", "SampleEventWQ")) %>%
  collect() %>%
  filter(substring(SampleEventID, 1, 2) %in% Estuaries, 
         substring(SampleEventID, 8, 11) %in% YearFilter)

hsdbStarOddi <- tbl(con,in_schema("hsdb", "DataLoggerWQ")) %>%
  collect() %>%
  filter(FixedLocationID != "0021") # this filters out the AB datalogger data

hsdbRecruitment <- tbl(con,in_schema("hsdb", "Recruitment")) %>%
  collect() %>%
  filter(substring(SampleEventID, 1, 2) %in% Estuaries, 
         substring(SampleEventID, 8, 11) %in% YearFilter)

hsdbSedimentTrap <- tbl(con,in_schema("hsdb", "SedimentTrap")) %>%
  collect() %>%
  filter(substring(SampleEventID, 1, 2) %in% Estuaries, 
         substring(SampleEventID, 8, 11) %in% YearFilter)

DBI::dbDisconnect(con)
```

```{r BasicStats}
# Arrange data frames using data from the database, doing basic filters, adding necessary columns for statistics and performing statistics.

# Fixed Locations
FixedLocations <- dboFixedLocations %>% 
  mutate(StationNumber = as.factor(StationNumber)) %>% #changed to factor based on EL's code
  select(FixedLocationID,
         Estuary,
         SectionName, 
         StationNumber) %>% 
  distinct()

# WaterQuality
WaterQuality <- hsdbWaterQuality %>%
  mutate(SampleDate = as.Date(substring(SampleEventID, 8, 15), format = "%Y%m%d"),
         Year = year(SampleDate),
         Month = month(SampleDate),
         FixedLocationID = substring(SampleEventID, 19, 22), 
         AnalysisDate = floor_date(SampleDate, unit = "month"),
         Plot_Date = AnalysisDate + 14) %>%
  select(SampleEventWQID,
         SampleDate,
         AnalysisDate,
         Plot_Date,
         Year,
         Month,
         FixedLocationID,
         Temperature,
         Salinity,
         DissolvedOxygen, 
         TurbidityYSI) %>%
  left_join(FixedLocations, by = c("FixedLocationID")) 

WaterQualityStats1 <- WaterQuality %>% # Show the mean and SD; max and min for all WQ parameters per STATION, per month
  group_by(AnalysisDate, 
           Plot_Date, 
           Estuary, 
           StationNumber, 
           SectionName) %>% 
  summarise(TempMean = ifelse(all(is.na(Temperature)), NA, mean(Temperature, na.rm = TRUE)),
            TempSD = ifelse(all(is.na(Temperature)), NA, sd(Temperature, na.rm = TRUE)),
            TempMax = ifelse(all(is.na(Temperature)), NA, max(Temperature, na.rm = TRUE)),
            TempMin = ifelse(all(is.na(Temperature)), NA, min(Temperature, na.rm = TRUE)),
            SalMean = ifelse(all(is.na(Salinity)), NA, mean(Salinity, na.rm = TRUE)),
            SalSD = ifelse(all(is.na(Salinity)), NA, sd(Salinity, na.rm = TRUE)),
            SalMax = ifelse(all(is.na(Salinity)), NA, max(Salinity, na.rm = TRUE)),
            SalMin = ifelse(all(is.na(Salinity)), NA, min(Salinity, na.rm = TRUE)),
            DOMean = ifelse(all(is.na(DissolvedOxygen)), NA, mean(DissolvedOxygen, na.rm = TRUE)),
            DOSD = ifelse(all(is.na(DissolvedOxygen)), NA, sd(DissolvedOxygen, na.rm = TRUE)),
            DOMax = ifelse(all(is.na(DissolvedOxygen)), NA, max(DissolvedOxygen, na.rm = TRUE)),
            DOMin = ifelse(all(is.na(DissolvedOxygen)), NA, min(DissolvedOxygen, na.rm = TRUE)),
            TurbMean = ifelse(all(is.na(TurbidityYSI)), NA, mean(TurbidityYSI, na.rm = TRUE)),
            TurbSD = ifelse(all(is.na(TurbidityYSI)), NA, sd(TurbidityYSI, na.rm = TRUE)),
            TurbMax = ifelse(all(is.na(TurbidityYSI)), NA, max(TurbidityYSI, na.rm = TRUE)),
            TurbMin = ifelse(all(is.na(TurbidityYSI)), NA, min(TurbidityYSI, na.rm = TRUE)))

WaterQualityStats2 <- WaterQuality %>% # Show the mean and SD; max and min for all WQ parameters per SECTION, per month
  group_by(AnalysisDate, 
           Plot_Date, 
           Estuary,  
           SectionName) %>% 
  summarise(TempMean = ifelse(all(is.na(Temperature)), NA, mean(Temperature, na.rm = TRUE)),
            TempSD = ifelse(all(is.na(Temperature)), NA, sd(Temperature, na.rm = TRUE)),
            TempMax = ifelse(all(is.na(Temperature)), NA, max(Temperature, na.rm = TRUE)),
            TempMin = ifelse(all(is.na(Temperature)), NA, min(Temperature, na.rm = TRUE)),
            SalMean = ifelse(all(is.na(Salinity)), NA, mean(Salinity, na.rm = TRUE)),
            SalSD = ifelse(all(is.na(Salinity)), NA, sd(Salinity, na.rm = TRUE)),
            SalMax = ifelse(all(is.na(Salinity)), NA, max(Salinity, na.rm = TRUE)),
            SalMin = ifelse(all(is.na(Salinity)), NA, min(Salinity, na.rm = TRUE)),
            DOMean = ifelse(all(is.na(DissolvedOxygen)), NA, mean(DissolvedOxygen, na.rm = TRUE)),
            DOSD = ifelse(all(is.na(DissolvedOxygen)), NA, sd(DissolvedOxygen, na.rm = TRUE)),
            DOMax = ifelse(all(is.na(DissolvedOxygen)), NA, max(DissolvedOxygen, na.rm = TRUE)),
            DOMin = ifelse(all(is.na(DissolvedOxygen)), NA, min(DissolvedOxygen, na.rm = TRUE)),
            TurbMean = ifelse(all(is.na(TurbidityYSI)), NA, mean(TurbidityYSI, na.rm = TRUE)),
            TurbSD = ifelse(all(is.na(TurbidityYSI)), NA, sd(TurbidityYSI, na.rm = TRUE)),
            TurbMax = ifelse(all(is.na(TurbidityYSI)), NA, max(TurbidityYSI, na.rm = TRUE)),
            TurbMin = ifelse(all(is.na(TurbidityYSI)), NA, min(TurbidityYSI, na.rm = TRUE)))

# Star-Oddi
StarOddi <- hsdbStarOddi %>%
  mutate(SampleDate = as.Date(WQDateTime, unit = "date"),
         AnalysisDate = floor_date(SampleDate, unit = "month"),
         Plot_Date = AnalysisDate + 14) %>%
  select(SampleDate,
         AnalysisDate,
         Plot_Date,
         FixedLocationID,
         Temperature,
         Salinity) %>%
  left_join(FixedLocations, by = c("FixedLocationID")) 

StarOddiStats1 <- StarOddi %>% # Show the DAILY mean and SD of Temp and Salinity
  group_by(SampleDate,  
           Estuary,  
           SectionName) %>% 
  summarise(TempMean = ifelse(all(is.na(Temperature)), NA, mean(Temperature, na.rm = TRUE)),
            TempSD = ifelse(all(is.na(Temperature)), NA, sd(Temperature, na.rm = TRUE)),
            SalMean = ifelse(all(is.na(Salinity)), NA, mean(Salinity, na.rm = TRUE)),
            SalSD = ifelse(all(is.na(Salinity)), NA, sd(Salinity, na.rm = TRUE))) %>%
  arrange(Estuary, SectionName, SampleDate)

# Recruitment
Recruitment <- hsdbRecruitment %>% 
  filter(ShellPosition %in% c(2,3,4,5,8,9,10,11)) %>%
  mutate(DeployedDate = as.Date(DeployedDate), 
         RetDate = as.Date(substring(SampleEventID, 8, 15), format = "%Y%m%d"),
         Year = year(RetDate),
         FixedLocationID = substring(ShellID, 19, 22), 
         NumDays = as.numeric(RetDate - DeployedDate),
         BottomMonth= NumBottom/(NumDays/28),
         AnalysisDate = floor_date(RetDate, unit = "month"),
         Plot_Date = AnalysisDate + 14) %>%
  select(ShellID,
         FixedLocationID,
         SampleEventID,
         DeployedDate,
         RetDate,
         AnalysisDate,
         Plot_Date,
         Year,
         NumDays,
         ShellPosition,
         NumBottom,
         BottomMonth) %>% 
  left_join(FixedLocations, by = c("FixedLocationID")) 

RecruitmentStats1 <- Recruitment %>%
  group_by(AnalysisDate, 
           Plot_Date, 
           Estuary, 
           StationNumber, 
           SectionName) %>% 
  summarise(RecMean = mean(BottomMonth, na.rm = TRUE))

RecruitmentStats2 <- RecruitmentStats1 %>% # Shows the mean and max monthly recruitment rate for each estuary
  group_by(AnalysisDate, 
           Plot_Date, 
           Estuary) %>% 
  summarise(RecruitMean = mean(RecMean, na.rm = TRUE),
            RecMax = max(RecMean, na.rm = TRUE))

RecruitmentStats3 <- RecruitmentStats1 %>% # Shows the mean and max recruitment rate for each station in each estuary
  group_by(Estuary,
           StationNumber) %>% 
  summarise(RecruitMean = mean(RecMean, na.rm = TRUE),
            RecMax = max(RecMean, na.rm = TRUE))

# SedimentTrap
Sediment <- hsdbSedimentTrap %>% 
  mutate(DeployedDate = as.Date(DeployedDate), 
         RetDate = as.Date(substring(SampleEventID, 8, 15), format = "%Y%m%d"),
         FixedLocationID = substring(SampleEventID, 19, 22), 
         NumDays = as.numeric(RetDate - DeployedDate),
         SedWt = (FilterDryWeight + PanDryWeight) - (FilterTareWeight + FilterTareWeight),
         SedRate = SedWt / (NumDays / 28),
         AnalysisDate = floor_date(RetDate, unit = "month"),
         Plot_Date = AnalysisDate + 14,
         ExcessBiota = ifelse(NumDrills > 5 | NumCrabs > 2 | NumHermitCrabs > 20 | NumFish > 2 | NumOtherBiota > 2, "Y", "N")) %>%
  select(CupSampleID,
         FixedLocationID,
         SampleEventID,
         DeployedDate,
         RetDate,
         AnalysisDate,
         Plot_Date,
         NumDays,
         SedWt,
         SedRate,
         ExcessBiota) %>% 
  left_join(FixedLocations, by = c("FixedLocationID")) 

SedimentStats1 <- Sediment %>%
  group_by(AnalysisDate, 
           Plot_Date, 
           Estuary, 
           StationNumber, 
           SectionName) %>% 
  summarise(SedRateMean = ifelse(all(is.na(SedRate)), NA, mean(SedRate, na.rm = TRUE)),
            SedRateSD = ifelse(all(is.na(SedRate)), NA, sd(SedRate, na.rm = TRUE)))

SedimentStats2 <- Sediment %>% 
  group_by(AnalysisDate, 
           Plot_Date, 
           Estuary) %>% 
  summarise(SedRateMean = ifelse(all(is.na(SedRate)), NA, mean(SedRate, na.rm = TRUE)),
            SedRateSD = ifelse(all(is.na(SedRate)), NA, sd(SedRate, na.rm = TRUE)))

SedimentStats3 <- Sediment %>% 
  group_by(Estuary,
           StationNumber) %>% 
  summarise(SedRateMean = ifelse(all(is.na(SedRate)), NA, mean(SedRate, na.rm = TRUE)),
            SedRateSD = ifelse(all(is.na(SedRate)), NA, sd(SedRate, na.rm = TRUE)))


```
